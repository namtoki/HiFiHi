# Auracast Assistant + AWSãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–‹ç™ºè¨­è¨ˆæ›¸ v3

Flutterï¼ˆAndroidå„ªå…ˆï¼‰ã§Auracast Assistantã‚¢ãƒ—ãƒªã‚’é–‹ç™ºã—ã€AWSãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆæ±äº¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ ap-northeast-1ï¼‰ã¨é€£æºã™ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åŒ…æ‹¬çš„ãªæŠ€è¡“è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã™ã€‚

**æœ¬ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ**: Airoha SDKã«ä¾å­˜ã›ãšã€Androidæ¨™æº–BLE API + æ¥ç¶šæ¸ˆã¿ã‚¤ãƒ¤ãƒ›ãƒ³å´ã®BASSï¼ˆBroadcast Audio Scan Serviceï¼‰GATTã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã¦ã‚¢ãƒ—ãƒªå†…å®Œçµã§å®Ÿè£…ã—ã¾ã™ã€‚

---

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å…¨ä½“åƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            AURACAST ASSISTANT ARCHITECTURE v3                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ MOBILE (Flutter)                                                                                    â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚   UI Layer   â”‚  â”‚   Riverpod   â”‚  â”‚Method Channelâ”‚  â”‚    Hive      â”‚  â”‚  Map Widget  â”‚          â”‚
â”‚ â”‚ Material 3   â”‚â—„â”€â”¤    State     â”‚â—„â”€â”¤ Native BLE   â”‚  â”‚Local Storage â”‚  â”‚   åœ°å›³è¡¨ç¤º    â”‚          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ANDROID NATIVE (Kotlin)                                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚  BluetoothLeScanner    â”‚  GATT Client (BASS)  â”‚  PA Sync Manager   â”‚  Location Services      â”‚  â”‚
â”‚ â”‚  Broadcast Discovery   â”‚  Add Source to Sink  â”‚  BIG Sync Control  â”‚  GPS/Networkä½ç½®å–å¾—    â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AWS BACKEND (ap-northeast-1) - ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ¼ãƒ³                                                       â”‚
â”‚                                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                              API Layer (çµ±åˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ)                                  â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚    â”‚
â”‚  â”‚  â”‚ CloudFront   â”‚  â”‚ API Gateway  â”‚  â”‚   AppSync    â”‚  â”‚  WebSocket   â”‚                   â”‚    â”‚
â”‚  â”‚  â”‚    CDN       â”‚  â”‚  REST API    â”‚  â”‚   GraphQL    â”‚  â”‚  API (ãƒªã‚¢ãƒ«  â”‚                   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   ã‚¿ã‚¤ãƒ )    â”‚                   â”‚    â”‚
â”‚  â”‚         â”‚                 â”‚                 â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚            â”‚                 â”‚                 â”‚                â”‚                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚         â–¼                 â–¼                 â–¼                â–¼                             â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚                              Lambda Functions                                         â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†â”‚ â”‚ãƒãƒ£ãƒ³ãƒãƒ«  â”‚ â”‚ãƒ¬ãƒ“ãƒ¥ãƒ¼    â”‚ â”‚å†ç”Ÿäººæ•°    â”‚ â”‚åœ°å›³ãƒ»ä½ç½®  â”‚         â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ Lambda     â”‚ â”‚ç®¡ç† Lambda â”‚ â”‚å‡¦ç† Lambda â”‚ â”‚é›†è¨ˆ Lambda â”‚ â”‚æ¤œç´¢ Lambda â”‚         â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â”‚                                          â”‚                                                â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚
â”‚  â”‚  â”‚                              Data Layer                                             â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚  DynamoDB    â”‚  â”‚ ElastiCache  â”‚  â”‚  OpenSearch  â”‚  â”‚     S3       â”‚           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ Single-Table â”‚  â”‚   (Redis)    â”‚  â”‚  Service     â”‚  â”‚  Data Lake   â”‚           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ ãƒ¦ãƒ¼ã‚¶ãƒ¼/    â”‚  â”‚ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  â”‚  â”‚ å£ã‚³ãƒŸæ¤œç´¢   â”‚  â”‚  åˆ†æãƒ‡ãƒ¼ã‚¿  â”‚           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ ãƒãƒ£ãƒ³ãƒãƒ«/  â”‚  â”‚ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼   â”‚  â”‚ å…¨æ–‡æ¤œç´¢     â”‚  â”‚  ä¿å­˜        â”‚           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â”‚ ãƒ¬ãƒ“ãƒ¥ãƒ¼     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â”‚    â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                   â”‚  â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚
â”‚  â”‚                                                                                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ AWS BACKEND (ap-northeast-1) - èªè¨¼ãƒ»åˆ†æãƒ—ãƒ¬ãƒ¼ãƒ³                                                   â”‚
â”‚                                                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                              Authentication & ML Layer                                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚   Cognito    â”‚  â”‚ Personalize  â”‚  â”‚  Comprehend  â”‚  â”‚   Kinesis    â”‚  â”‚  Location    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  User Pools  â”‚  â”‚  MLæ¨è–¦      â”‚  â”‚  æ„Ÿæƒ…åˆ†æ    â”‚  â”‚  Data Stream â”‚  â”‚   Service    â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼â”‚  â”‚  ã‚¨ãƒ³ã‚¸ãƒ³    â”‚  â”‚  ãƒ†ã‚­ã‚¹ãƒˆ    â”‚  â”‚  ã‚¤ãƒ™ãƒ³ãƒˆ    â”‚  â”‚  åœ°å›³ãƒ»ä½ç½®  â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ã‚½ãƒ¼ã‚·ãƒ£ãƒ«  â”‚  â”‚              â”‚  â”‚  åˆ†é¡        â”‚  â”‚  ã‚¹ãƒˆãƒªãƒ¼ãƒ   â”‚  â”‚  æ¤œç´¢        â”‚   â”‚ â”‚
â”‚  â”‚  â”‚  ãƒ­ã‚°ã‚¤ãƒ³    â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚  â”‚              â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â”‚         â”‚                 â”‚                 â”‚                 â”‚                â”‚            â”‚ â”‚
â”‚  â”‚         â”‚                 â”‚                 â”‚                 â”‚                â”‚            â”‚ â”‚
â”‚  â”‚         â–¼                 â–¼                 â–¼                 â–¼                â–¼            â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚                              EventBridge (ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•)                               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²å®Œäº† â†’ ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ                                                   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  ãƒãƒ£ãƒ³ãƒãƒ«é¸æŠ â†’ ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰æ›´æ–°                                                       â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ â†’ æ„Ÿæƒ…åˆ†æå®Ÿè¡Œ                                                          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  å†ç”Ÿé–‹å§‹/çµ‚äº† â†’ ãƒªã‚¹ãƒŠãƒ¼æ•°æ›´æ–°                                                        â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. Bluetooth LE Audio å®Ÿè£…ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1.1 é‡è¦ãªåŒºåˆ¥ï¼šã‚·ã‚¹ãƒ†ãƒ BASS vs ã‚¤ãƒ¤ãƒ›ãƒ³å´BASS

Android 13ä»¥é™ã€`BluetoothLeBroadcastAssistant`ï¼ˆã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ã®Broadcast Assistant APIï¼‰ã¯ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ—ãƒªã®ã¿ã«åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚**ã—ã‹ã—**ã€ã“ã‚Œã¯æ¥ç¶šæ¸ˆã¿ã‚¤ãƒ¤ãƒ›ãƒ³ï¼ˆSinkï¼‰å´ã®BASS GATTã‚µãƒ¼ãƒ“ã‚¹ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™ã¨ã¯ç•°ãªã‚Šã¾ã™ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         BASS ã‚¢ã‚¯ã‚»ã‚¹ã®åŒºåˆ¥                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  âŒ BluetoothLeBroadcastAssistant API (ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«)                       â”‚
â”‚     - Android 13+ ã§ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¢ãƒ—ãƒªã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯                       â”‚
â”‚     - ã‚·ã‚¹ãƒ†ãƒ UIãŒä½¿ç”¨                                                       â”‚
â”‚                                                                             â”‚
â”‚  âœ… ã‚¤ãƒ¤ãƒ›ãƒ³å´ BASS GATT Service (ãƒ‡ãƒã‚¤ã‚¹ãƒ¬ãƒ™ãƒ«)                            â”‚
â”‚     - æ¥ç¶šæ¸ˆã¿BLEãƒ‡ãƒã‚¤ã‚¹ã®GATTã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å…¬é–‹                             â”‚
â”‚     - æ¨™æº–BluetoothGatt APIã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½                                   â”‚
â”‚     - ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¢ãƒ—ãƒªã‹ã‚‰æ“ä½œå¯èƒ½                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æœ¬è¨­è¨ˆã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ã‚¢ãƒ—ãƒªå†…å®Œçµã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚  Broadcast  â”‚      â”‚   Denon     â”‚      â”‚  Denon TWS  â”‚                â”‚
â”‚   â”‚   Source    â”‚ â”€â”€â”€â–º â”‚    App      â”‚ â”€â”€â”€â–º â”‚  (Sink)     â”‚                â”‚
â”‚   â”‚  (Auracast) â”‚      â”‚ (Assistant) â”‚      â”‚             â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚         â”‚                    â”‚                    â”‚                         â”‚
â”‚         â”‚                    â”‚                    â”‚                         â”‚
â”‚    Extended ADV         GATTçµŒç”±ã§           BASS GATT                      â”‚
â”‚    (BAAS UUID)          æ¥ç¶šæŒ‡ç¤º             Service                        â”‚
â”‚                                                                             â”‚
â”‚   å‡¦ç†ãƒ•ãƒ­ãƒ¼:                                                                â”‚
â”‚   1. ã‚¹ã‚­ãƒ£ãƒ³: BluetoothLeScanner + ScanFilter (BAAS UUID: 0x1852)          â”‚
â”‚   2. é¸æŠUI: ã‚¢ãƒ—ãƒªå†…ã§ç‹¬è‡ªUIè¡¨ç¤º                                            â”‚
â”‚   3. æ¥ç¶šæŒ‡ç¤º: ã‚¤ãƒ¤ãƒ›ãƒ³å´BASS GATTã®Control PointçµŒç”±                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 API Levelè¦ä»¶

| æ©Ÿèƒ½ | æœ€å°API Level | å¯¾å¿œAndroid | å‚™è€ƒ |
|------|---------------|-------------|------|
| LE Audio Protocol Stack | API 33 | Android 13 | åŸºç›¤ã‚µãƒãƒ¼ãƒˆ |
| BluetoothLeScanner (Extended ADV) | API 26+ | Android 8+ | setLegacy(false)å¿…é ˆ |
| GATT Client | API 21+ | Android 5+ | æ¨™æº–BLE API |
| Auracast Broadcastæ¤œå‡º | API 33+ | Android 13+ | ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ä¾å­˜ |

### 1.4 AndroidManifest.xmlè¨­å®š

```xml
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <!-- Android 12+ Bluetooth permissions -->
    <uses-permission android:name="android.permission.BLUETOOTH_SCAN"
                     android:usesPermissionFlags="neverForLocation" />
    <uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />
    
    <!-- Legacy permissions (Android 11 and below) -->
    <uses-permission android:name="android.permission.BLUETOOTH"
                     android:maxSdkVersion="30" />
    <uses-permission android:name="android.permission.BLUETOOTH_ADMIN"
                     android:maxSdkVersion="30" />
    
    <!-- Hardware features -->
    <uses-feature android:name="android.hardware.bluetooth_le" android:required="true"/>
</manifest>
```

---

## 2. Bluetooth SIG AuracastæŠ€è¡“ä»•æ§˜

### 2.1 Public Broadcast Profile (PBP) v1.0.1

**å½¹å‰²å®šç¾©:**

| å½¹å‰² | ç•¥ç§° | èª¬æ˜ |
|------|------|------|
| Public Broadcast Source | PBS | ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚’é€ä¿¡ãƒ»ã‚¢ãƒŠã‚¦ãƒ³ã‚¹ |
| Public Broadcast Sink | PBK | ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆéŸ³å£°ã‚’å—ä¿¡ãƒ»å†ç”Ÿ |
| Public Broadcast Assistant | PBA | ã‚·ãƒ³ã‚¯ãƒ‡ãƒã‚¤ã‚¹ã®æ¥ç¶šã‚’åˆ¶å¾¡ï¼ˆæœ¬ã‚¢ãƒ—ãƒªã®å½¹å‰²ï¼‰ |

### 2.2 BASS (Broadcast Audio Scan Service) ä»•æ§˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BASS GATT Service Structure                               â”‚
â”‚                    UUID: 0x184F                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Characteristics:                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Broadcast Audio Scan Control Point (BASCP)                         â”‚     â”‚
â”‚  â”‚ UUID: 0x2BC7                                                       â”‚     â”‚
â”‚  â”‚ Properties: Write                                                  â”‚     â”‚
â”‚  â”‚ Operations:                                                        â”‚     â”‚
â”‚  â”‚   - 0x00: Remote Scan Stopped                                      â”‚     â”‚
â”‚  â”‚   - 0x01: Remote Scan Started                                      â”‚     â”‚
â”‚  â”‚   - 0x02: Add Source                                               â”‚     â”‚
â”‚  â”‚   - 0x03: Modify Source                                            â”‚     â”‚
â”‚  â”‚   - 0x04: Set Broadcast_Code                                       â”‚     â”‚
â”‚  â”‚   - 0x05: Remove Source                                            â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Broadcast Receive State                                            â”‚     â”‚
â”‚  â”‚ UUID: 0x2BC8                                                       â”‚     â”‚
â”‚  â”‚ Properties: Read, Notify                                           â”‚     â”‚
â”‚  â”‚ Contents:                                                          â”‚     â”‚
â”‚  â”‚   - Source_ID (1 octet)                                            â”‚     â”‚
â”‚  â”‚   - Source_Address_Type (1 octet)                                  â”‚     â”‚
â”‚  â”‚   - Source_Address (6 octets)                                      â”‚     â”‚
â”‚  â”‚   - Source_Adv_SID (1 octet)                                       â”‚     â”‚
â”‚  â”‚   - Broadcast_ID (3 octets)                                        â”‚     â”‚
â”‚  â”‚   - PA_Sync_State (1 octet)                                        â”‚     â”‚
â”‚  â”‚   - BIG_Encryption (1 octet)                                       â”‚     â”‚
â”‚  â”‚   - Num_Subgroups + BIS_Sync_State per subgroup                    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Add Source Operation ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Add Source (Opcode 0x02) Payload                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Offset  Size   Field                    Description                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€  â”€â”€â”€â”€   â”€â”€â”€â”€â”€                    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                        â”‚
â”‚  0       1      Opcode                   0x02 (Add Source)                  â”‚
â”‚  1       1      Advertiser_Address_Type  0x00=Public, 0x01=Random           â”‚
â”‚  2       6      Advertiser_Address       Broadcast Source BT Address        â”‚
â”‚  8       1      Advertising_SID          SID from Extended ADV (0x00-0x0F)  â”‚
â”‚  9       3      Broadcast_ID             24-bit Broadcast identifier        â”‚
â”‚  12      1      PA_Sync                  0x00=No sync, 0x01=Sync to PA      â”‚
â”‚  13      2      PA_Interval              PA interval (1.25ms units)         â”‚
â”‚  15      1      Num_Subgroups            Number of subgroups to sync        â”‚
â”‚  16+     var    Subgroup entries         BIS_Sync (4) + Metadata_Len (1)    â”‚
â”‚                                          + Metadata (var) per subgroup      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 BASE (Broadcast Audio Source Endpoint) ãƒ‡ãƒ¼ã‚¿æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LEVEL 1: Broadcast Source (BIG Level)                                       â”‚
â”‚ â”œâ”€â”€ Presentation_Delay (3 octets) - ãƒã‚¤ã‚¯ãƒ­ç§’å˜ä½                          â”‚
â”‚ â”œâ”€â”€ Num_Subgroups (1 octet) - 1-255                                        â”‚
â”‚ â””â”€â”€ Subgroup entries...                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LEVEL 2: Subgroups (å…±æœ‰ã‚³ãƒ¼ãƒ‡ãƒƒã‚¯è¨­å®š/ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿)                           â”‚
â”‚ â”œâ”€â”€ Num_BIS (1 octet)                                                      â”‚
â”‚ â”œâ”€â”€ Codec_ID (5 octets) - LC3: 0x06                                        â”‚
â”‚ â”œâ”€â”€ Codec_Specific_Configuration (LTV)                                      â”‚
â”‚ â”œâ”€â”€ Metadata (LTV)                                                          â”‚
â”‚ â””â”€â”€ BIS entries...                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ LEVEL 3: BIS (å€‹åˆ¥ã‚¹ãƒˆãƒªãƒ¼ãƒ è¨­å®š)                                            â”‚
â”‚ â”œâ”€â”€ BIS_index (1 octet) - 1-31                                              â”‚
â”‚ â””â”€â”€ Codec_Specific_Configuration (LTV)                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.5 ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿LTVå½¢å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Length â”‚  Type  â”‚     Value       â”‚
â”‚ 1 byte â”‚ 1 byte â”‚ (Length-1) bytesâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¸»è¦ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¿ã‚¤ãƒ—:**

| Type Code | åç§° | èª¬æ˜ |
|-----------|------|------|
| 0x01 | Preferred_Audio_Contexts | 16-bit Context Type |
| 0x02 | Streaming_Audio_Contexts | 16-bit Context Type |
| 0x03 | Program_Info | UTF-8æ–‡å­—åˆ—ï¼ˆç•ªçµ„æƒ…å ±ï¼‰ |
| 0x04 | Language | ISO 639-3è¨€èªã‚³ãƒ¼ãƒ‰ |
| 0x0C | Broadcast_Name | UTF-8æ–‡å­—åˆ—ï¼ˆ4-32æ–‡å­—ï¼‰ |

### 2.6 Broadcast_ID / Broadcast Codeä»•æ§˜

```
Broadcast_ID: 3 bytes (24 bits) - BIGã‚’ä¸€æ„ã«è­˜åˆ¥ã™ã‚‹ãƒ©ãƒ³ãƒ€ãƒ å€¤

Broadcast_Code: 16 octets (128 bits) - æš—å·åŒ–ã‚­ãƒ¼
- ASCIIæ–‡å­—åˆ—ï¼ˆUTF-8ï¼‰ã€æœ«å°¾ã‚¼ãƒ­ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°
- ä¾‹: "GymTime$2day" â†’ 0x47 0x79 0x6D... 0x00 0x00 0x00 0x00

æš—å·åŒ–ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ : AES-CCM (128-bit key)
MIC (Message Integrity Check): 4 bytes
```

---

## 3. ç”»é¢é·ç§»ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 1: ã‚¤ãƒ¤ãƒ›ãƒ³æ¥ç¶šæ¸ˆã¿çŠ¶æ…‹                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                        â”‚
â”‚  â”‚  â”‚      ğŸ§ Denon TWS         â”‚  â”‚                                        â”‚
â”‚  â”‚  â”‚      æ¥ç¶šæ¸ˆã¿              â”‚  â”‚                                        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                        â”‚
â”‚  â”‚                                 â”‚                                        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                        â”‚
â”‚  â”‚  â”‚  ğŸ”Š Auracast              â”‚  â”‚  â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¿ãƒƒãƒ—                     â”‚
â”‚  â”‚  â”‚  ã€Œå‘¨å›²ã®æ”¾é€ã‚’æ¢ã™ã€       â”‚  â”‚                                        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 2: ã‚¹ã‚­ãƒ£ãƒ³ä¸­ï¼ˆã‚¢ãƒ—ãƒªå†…UIï¼‰                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚  â† Auracastæ”¾é€                â”‚                                         â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                                        â”‚
â”‚  â”‚                                 â”‚                                        â”‚
â”‚  â”‚  å‘¨å›²ã®ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆã‚’æ¤œç´¢ä¸­... â”‚                                        â”‚
â”‚  â”‚         â—  â—¡ â—                   â”‚   BluetoothLeScanner                   â”‚
â”‚  â”‚                                 â”‚   + ScanFilter (UUID 0x1852)           â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                                        â”‚
â”‚  â”‚  åˆ©ç”¨å¯èƒ½ãªæ”¾é€:                 â”‚                                        â”‚
â”‚  â”‚                                 â”‚                                        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                        â”‚
â”‚  â”‚  â”‚ ğŸ“» Cafe Jazz BGM          â”‚  â”‚  â† Extended ADVã‹ã‚‰æ¤œå‡º                â”‚
â”‚  â”‚  â”‚    -45dBm | LC3 48kHz     â”‚  â”‚                                        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                        â”‚
â”‚  â”‚                                 â”‚                                        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                        â”‚
â”‚  â”‚  â”‚ ğŸ“» Museum Audio Guide     â”‚  â”‚                                        â”‚
â”‚  â”‚  â”‚    -62dBm | LC3 24kHz     â”‚  â”‚                                        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 3: æ¥ç¶šå‡¦ç†ï¼ˆã‚¢ãƒ—ãƒªå†…ï¼‰                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚                                 â”‚                                        â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    å‡¦ç†å†…å®¹:                           â”‚
â”‚  â”‚   â”‚                         â”‚   â”‚    1. TWSå´BASS GATTã«æ¥ç¶š             â”‚
â”‚  â”‚   â”‚  "Cafe Jazz BGM" ã«     â”‚   â”‚    2. BASCP Write (Add Source)        â”‚
â”‚  â”‚   â”‚   æ¥ç¶šä¸­...              â”‚   â”‚    3. PA Syncç¢ºç«‹                     â”‚
â”‚  â”‚   â”‚                         â”‚   â”‚    4. BIG Syncç¢ºç«‹                    â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚    5. BISå—ä¿¡é–‹å§‹                     â”‚
â”‚  â”‚   â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘ 80%   â”‚   â”‚   â”‚                                       â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚                                       â”‚
â”‚  â”‚   â”‚                         â”‚   â”‚                                       â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                                        â”‚
â”‚  â”‚                                 â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“ æ¥ç¶šå®Œäº†
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STEP 4: å†ç”Ÿä¸­                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                        â”‚
â”‚  â”‚  â”‚      ğŸ§ Denon TWS         â”‚  â”‚                                        â”‚
â”‚  â”‚  â”‚      æ¥ç¶šæ¸ˆã¿              â”‚  â”‚                                        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                        â”‚
â”‚  â”‚                                 â”‚                                        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                        â”‚
â”‚  â”‚  â”‚  ğŸ”Š ç¾åœ¨ã®éŸ³å£°ã‚½ãƒ¼ã‚¹:      â”‚  â”‚                                        â”‚
â”‚  â”‚  â”‚  ğŸ“» Cafe Jazz BGM        â”‚  â”‚  â† BASS Receive Stateç›£è¦–              â”‚
â”‚  â”‚  â”‚                           â”‚  â”‚                                        â”‚
â”‚  â”‚  â”‚  â–¶ï¸ å†ç”Ÿä¸­ | LC3 48kHz    â”‚  â”‚                                        â”‚
â”‚  â”‚  â”‚                           â”‚  â”‚                                        â”‚
â”‚  â”‚  â”‚     [åˆ‡æ–­ã™ã‚‹]            â”‚  â”‚                                        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ 

### 4.1 Flutter ã‚¢ãƒ—ãƒªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
auracast_assistant/
â”œâ”€â”€ android/
â”‚   â””â”€â”€ app/src/main/kotlin/com/denon/auracast/
â”‚       â”œâ”€â”€ MainActivity.kt
â”‚       â”œâ”€â”€ bluetooth/
â”‚       â”‚   â”œâ”€â”€ AuracastScanner.kt         # Broadcast Sourceæ¤œå‡º
â”‚       â”‚   â”œâ”€â”€ BassGattManager.kt         # BASS GATTæ“ä½œ
â”‚       â”‚   â”œâ”€â”€ BroadcastSourceParser.kt   # ADVãƒ‡ãƒ¼ã‚¿ãƒ‘ãƒ¼ã‚¹
â”‚       â”‚   â””â”€â”€ models/
â”‚       â”‚       â”œâ”€â”€ BroadcastSource.kt
â”‚       â”‚       â”œâ”€â”€ BaseData.kt
â”‚       â”‚       â””â”€â”€ BassState.kt
â”‚       â””â”€â”€ plugins/
â”‚           â””â”€â”€ AuracastPlugin.kt
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ main.dart
â”‚   â”œâ”€â”€ app.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ constants/
â”‚   â”‚   â”‚   â”œâ”€â”€ api_constants.dart
â”‚   â”‚   â”‚   â””â”€â”€ bluetooth_uuids.dart
â”‚   â”‚   â”œâ”€â”€ di/
â”‚   â”‚   â”‚   â””â”€â”€ injection.dart
â”‚   â”‚   â”œâ”€â”€ error/
â”‚   â”‚   â”‚   â”œâ”€â”€ failures.dart
â”‚   â”‚   â”‚   â””â”€â”€ exceptions.dart
â”‚   â”‚   â””â”€â”€ theme/
â”‚   â”‚       â””â”€â”€ app_theme.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ data/
â”‚   â”‚   â”œâ”€â”€ datasources/
â”‚   â”‚   â”‚   â”œâ”€â”€ local/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ broadcast_local_datasource.dart
â”‚   â”‚   â”‚   â””â”€â”€ remote/
â”‚   â”‚   â”‚       â””â”€â”€ broadcast_remote_datasource.dart
â”‚   â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”‚   â”œâ”€â”€ broadcast_source_model.dart
â”‚   â”‚   â”‚   â””â”€â”€ sink_device_model.dart
â”‚   â”‚   â””â”€â”€ repositories/
â”‚   â”‚       â””â”€â”€ auracast_repository_impl.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”œâ”€â”€ broadcast_source.dart
â”‚   â”‚   â”‚   â””â”€â”€ sink_device.dart
â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â””â”€â”€ auracast_repository.dart
â”‚   â”‚   â””â”€â”€ usecases/
â”‚   â”‚       â”œâ”€â”€ scan_broadcasts.dart
â”‚   â”‚       â”œâ”€â”€ add_source_to_sink.dart
â”‚   â”‚       â””â”€â”€ remove_source.dart
â”‚   â”‚
â”‚   â”œâ”€â”€ presentation/
â”‚   â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”‚   â”œâ”€â”€ auracast_provider.dart
â”‚   â”‚   â”‚   â””â”€â”€ sink_device_provider.dart
â”‚   â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”‚   â”œâ”€â”€ broadcast_list/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ broadcast_list_screen.dart
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ widgets/
â”‚   â”‚   â”‚   â”‚       â””â”€â”€ broadcast_card.dart
â”‚   â”‚   â”‚   â””â”€â”€ playback/
â”‚   â”‚   â”‚       â””â”€â”€ playback_screen.dart
â”‚   â”‚   â””â”€â”€ widgets/
â”‚   â”‚       â””â”€â”€ connection_status.dart
â”‚   â”‚
â”‚   â””â”€â”€ services/
â”‚       â””â”€â”€ auracast_channel.dart
â”‚
â”œâ”€â”€ test/
â””â”€â”€ pubspec.yaml
```

### 4.2 Terraform ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£æ§‹é€ 

```
terraform/
â”œâ”€â”€ main.tf                        # ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒã‚¤ãƒ³ãƒˆ
â”œâ”€â”€ variables.tf                   # å¤‰æ•°å®šç¾©
â”œâ”€â”€ outputs.tf                     # å‡ºåŠ›å€¤å®šç¾©
â”œâ”€â”€ backend.tf                     # ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒ†ãƒ¼ãƒˆè¨­å®š
â”‚
â”œâ”€â”€ environments/                  # ç’°å¢ƒåˆ¥è¨­å®š
â”‚   â”œâ”€â”€ dev/
â”‚   â”‚   â””â”€â”€ terraform.tfvars      # é–‹ç™ºç’°å¢ƒå¤‰æ•°
â”‚   â””â”€â”€ prod/
â”‚       â””â”€â”€ terraform.tfvars      # æœ¬ç•ªç’°å¢ƒå¤‰æ•°
â”‚
â””â”€â”€ modules/                       # å†åˆ©ç”¨å¯èƒ½ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
    â”œâ”€â”€ auth/                      # Cognito User Pool, Identity Pool
    â”‚   â”œâ”€â”€ main.tf
    â”‚   â”œâ”€â”€ variables.tf
    â”‚   â””â”€â”€ outputs.tf
    â”‚
    â”œâ”€â”€ database/                  # DynamoDB Single-Table Design
    â”‚   â”œâ”€â”€ main.tf
    â”‚   â”œâ”€â”€ variables.tf
    â”‚   â””â”€â”€ outputs.tf
    â”‚
    â”œâ”€â”€ api/                       # API Gateway, Lambda Functions
    â”‚   â”œâ”€â”€ main.tf
    â”‚   â”œâ”€â”€ variables.tf
    â”‚   â””â”€â”€ outputs.tf
    â”‚
    â”œâ”€â”€ analytics/                 # Personalize, OpenSearch, Kinesis, EventBridge
    â”‚   â”œâ”€â”€ main.tf
    â”‚   â”œâ”€â”€ variables.tf
    â”‚   â””â”€â”€ outputs.tf
    â”‚
    â”œâ”€â”€ realtime/                  # ElastiCache, WebSocket API, AppSync
    â”‚   â”œâ”€â”€ main.tf
    â”‚   â”œâ”€â”€ variables.tf
    â”‚   â””â”€â”€ outputs.tf
    â”‚
    â””â”€â”€ location/                  # Amazon Location Service
        â”œâ”€â”€ main.tf
        â”œâ”€â”€ variables.tf
        â””â”€â”€ outputs.tf
```

### 4.3 Terraform ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹æˆ

| ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« | ä¸»ãªãƒªã‚½ãƒ¼ã‚¹ | èª¬æ˜ |
|-----------|-------------|------|
| auth | Cognito User Pool, Identity Pool, OAuth Providers | ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ãƒ»èªå¯ |
| database | DynamoDB Tables (5 GSI), Streams | ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ– |
| api | API Gateway, Lambda, CloudWatch Logs | REST API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |
| analytics | Kinesis, OpenSearch, EventBridge, S3 | åˆ†æãƒ»MLåŸºç›¤ |
| realtime | ElastiCache Redis, WebSocket API, AppSync | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡ |
| location | Place Index, Map, Geofence, Tracker | ä½ç½®æƒ…å ±ã‚µãƒ¼ãƒ“ã‚¹ |

### 4.4 Terraform ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

```bash
# 1. åˆæœŸåŒ–
cd terraform
terraform init

# 2. é–‹ç™ºç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
terraform plan -var-file="environments/dev/terraform.tfvars"
terraform apply -var-file="environments/dev/terraform.tfvars"

# 3. å‡ºåŠ›å€¤ã®å–å¾—ï¼ˆFlutterè¨­å®šç”¨ï¼‰
terraform output flutter_amplify_config

# 4. æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
terraform plan -var-file="environments/prod/terraform.tfvars"
terraform apply -var-file="environments/prod/terraform.tfvars"
```

### 4.5 ç’°å¢ƒå¤‰æ•°ï¼ˆOAuthè¨­å®šï¼‰

```bash
# Google OAuth
export TF_VAR_google_client_id="your-google-client-id"
export TF_VAR_google_client_secret="your-google-client-secret"

# Apple Sign In
export TF_VAR_apple_client_id="your-apple-service-id"
export TF_VAR_apple_team_id="your-apple-team-id"
export TF_VAR_apple_key_id="your-apple-key-id"
export TF_VAR_apple_private_key="-----BEGIN PRIVATE KEY-----..."
```

### 4.6 Lambdaé–¢æ•°ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
lambda/
â”œâ”€â”€ users/
â”‚   â”œâ”€â”€ post_confirmation.py      # Cognito Post Confirmation Trigger
â”‚   â”œâ”€â”€ get_profile.py            # GET /users/me
â”‚   â””â”€â”€ update_profile.py         # PUT /users/me
â”‚
â”œâ”€â”€ broadcasts/
â”‚   â”œâ”€â”€ list.py                   # GET /broadcasts
â”‚   â”œâ”€â”€ get.py                    # GET /broadcasts/{id}
â”‚   â””â”€â”€ nearby.py                 # GET /broadcasts/nearby
â”‚
â”œâ”€â”€ reviews/
â”‚   â”œâ”€â”€ create_review.py          # POST /reviews
â”‚   â”œâ”€â”€ analyze_sentiment.py      # EventBridge trigger
â”‚   â””â”€â”€ aggregate_ratings.py      # Rating aggregation
â”‚
â”œâ”€â”€ recommendations/
â”‚   â”œâ”€â”€ get_recommendations.py    # GET /recommendations
â”‚   â””â”€â”€ record_event.py           # POST /events
â”‚
â”œâ”€â”€ listeners/
â”‚   â”œâ”€â”€ websocket_connect.py      # $connect
â”‚   â”œâ”€â”€ websocket_disconnect.py   # $disconnect
â”‚   â”œâ”€â”€ join_broadcast.py         # joinBroadcast action
â”‚   â””â”€â”€ aggregate_stats.py        # CloudWatch Events trigger
â”‚
â”œâ”€â”€ geo/
â”‚   â”œâ”€â”€ geohash_utils.py          # Geohash utilities
â”‚   â”œâ”€â”€ register_location.py      # PUT /broadcasts/{id}/location
â”‚   â””â”€â”€ search_nearby.py          # GET /broadcasts/nearby
â”‚
â””â”€â”€ shared/
    â”œâ”€â”€ db.py                     # DynamoDB utilities
    â”œâ”€â”€ auth.py                   # Authentication utilities
    â””â”€â”€ response.py               # API response helpers
```

---

## 5. Kotlinå®Ÿè£…ã‚³ãƒ¼ãƒ‰

### 5.1 Bluetooth UUIDså®šç¾©

```kotlin
// bluetooth/BluetoothUuids.kt
package com.denon.auracast.bluetooth

import android.os.ParcelUuid
import java.util.UUID

object BluetoothUuids {
    // Broadcast Audio Announcement Service (ã‚¹ã‚­ãƒ£ãƒ³ç”¨)
    val BROADCAST_AUDIO_ANNOUNCEMENT_SERVICE: ParcelUuid = 
        ParcelUuid.fromString("00001852-0000-1000-8000-00805F9B34FB")
    
    // Broadcast Audio Scan Service (ã‚¤ãƒ¤ãƒ›ãƒ³å´GATT)
    val BASS_SERVICE: UUID = 
        UUID.fromString("0000184F-0000-1000-8000-00805F9B34FB")
    
    // BASS Characteristics
    val BROADCAST_AUDIO_SCAN_CONTROL_POINT: UUID = 
        UUID.fromString("00002BC7-0000-1000-8000-00805F9B34FB")
    
    val BROADCAST_RECEIVE_STATE: UUID = 
        UUID.fromString("00002BC8-0000-1000-8000-00805F9B34FB")
    
    // Client Characteristic Configuration Descriptor
    val CCCD: UUID = 
        UUID.fromString("00002902-0000-1000-8000-00805F9B34FB")
}
```

### 5.2 Broadcast Source ã‚¹ã‚­ãƒ£ãƒŠãƒ¼

```kotlin
// bluetooth/AuracastScanner.kt
package com.denon.auracast.bluetooth

import android.bluetooth.BluetoothAdapter
import android.bluetooth.le.*
import android.os.Build
import android.os.ParcelUuid
import kotlinx.coroutines.channels.awaitClose
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.callbackFlow

data class DiscoveredBroadcast(
    val address: String,
    val addressType: Int,
    val name: String?,
    val rssi: Int,
    val broadcastId: Int,          // 24-bit Broadcast_ID
    val advertisingSid: Int,        // ADV SID (0x00-0x0F)
    val baseData: ByteArray?,       // BASE data from PA (if available)
    val isEncrypted: Boolean
)

class AuracastScanner(
    private val bluetoothAdapter: BluetoothAdapter
) {
    private var scanner: BluetoothLeScanner? = null
    private var scanCallback: ScanCallback? = null

    fun startScan(): Flow<DiscoveredBroadcast> = callbackFlow {
        if (Build.VERSION.SDK_INT < Build.VERSION_CODES.TIRAMISU) {
            close(IllegalStateException("LE Audio requires Android 13+"))
            return@callbackFlow
        }

        scanner = bluetoothAdapter.bluetoothLeScanner

        val filter = ScanFilter.Builder()
            .setServiceUuid(BluetoothUuids.BROADCAST_AUDIO_ANNOUNCEMENT_SERVICE)
            .build()

        val settings = ScanSettings.Builder()
            .setScanMode(ScanSettings.SCAN_MODE_LOW_LATENCY)
            .setLegacy(false)  // Extended Advertisingå¯¾å¿œå¿…é ˆ
            .setPhy(ScanSettings.PHY_LE_ALL_SUPPORTED)
            .build()

        scanCallback = object : ScanCallback() {
            override fun onScanResult(callbackType: Int, result: ScanResult) {
                parseBroadcastSource(result)?.let { broadcast ->
                    trySend(broadcast)
                }
            }

            override fun onScanFailed(errorCode: Int) {
                close(ScanException("Scan failed with error: $errorCode"))
            }
        }

        scanner?.startScan(listOf(filter), settings, scanCallback)

        awaitClose {
            stopScan()
        }
    }

    fun stopScan() {
        scanCallback?.let { callback ->
            scanner?.stopScan(callback)
        }
        scanCallback = null
    }

    private fun parseBroadcastSource(result: ScanResult): DiscoveredBroadcast? {
        val record = result.scanRecord ?: return null
        
        // Service Data from Broadcast Audio Announcement
        val serviceData = record.getServiceData(
            BluetoothUuids.BROADCAST_AUDIO_ANNOUNCEMENT_SERVICE
        ) ?: return null

        if (serviceData.size < 4) return null

        // Parse Broadcast Audio Announcement Service Data
        // Format: Broadcast_ID (3 bytes) + Public Broadcast Announcement features (1 byte)
        val broadcastId = (serviceData[0].toInt() and 0xFF) or
                         ((serviceData[1].toInt() and 0xFF) shl 8) or
                         ((serviceData[2].toInt() and 0xFF) shl 16)
        
        val pbpFeatures = serviceData[3].toInt() and 0xFF
        val isEncrypted = (pbpFeatures and 0x01) != 0

        return DiscoveredBroadcast(
            address = result.device.address,
            addressType = if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                result.device.addressType
            } else 0,
            name = record.deviceName,
            rssi = result.rssi,
            broadcastId = broadcastId,
            advertisingSid = result.advertisingSid,
            baseData = null,  // PA Syncã§å–å¾—
            isEncrypted = isEncrypted
        )
    }
}

class ScanException(message: String) : Exception(message)
```

### 5.3 BASS GATT Manager

```kotlin
// bluetooth/BassGattManager.kt
package com.denon.auracast.bluetooth

import android.bluetooth.*
import android.content.Context
import kotlinx.coroutines.*
import kotlinx.coroutines.flow.*
import java.util.concurrent.ConcurrentHashMap

sealed class BassState {
    object Disconnected : BassState()
    object Connecting : BassState()
    object Connected : BassState()
    data class SourceAdded(val sourceId: Int) : BassState()
    data class Synced(val sourceId: Int, val bisIndices: List<Int>) : BassState()
    data class Error(val message: String) : BassState()
}

data class BroadcastReceiveState(
    val sourceId: Int,
    val sourceAddress: String,
    val sourceAddressType: Int,
    val advertisingSid: Int,
    val broadcastId: Int,
    val paSyncState: PaSyncState,
    val bigEncryption: BigEncryption,
    val subgroups: List<SubgroupState>
)

enum class PaSyncState(val value: Int) {
    NOT_SYNCED(0x00),
    SYNC_INFO_REQUEST(0x01),
    SYNCED(0x02),
    FAILED(0x03),
    NO_PAST(0x04);
    
    companion object {
        fun fromValue(value: Int) = values().find { it.value == value } ?: NOT_SYNCED
    }
}

enum class BigEncryption(val value: Int) {
    NOT_ENCRYPTED(0x00),
    BROADCAST_CODE_REQUIRED(0x01),
    DECRYPTING(0x02),
    BAD_CODE(0x03);
    
    companion object {
        fun fromValue(value: Int) = values().find { it.value == value } ?: NOT_ENCRYPTED
    }
}

data class SubgroupState(
    val bisSync: Long,  // 32-bit bitmask
    val metadataLength: Int,
    val metadata: ByteArray
)

class BassGattManager(
    private val context: Context
) {
    private var bluetoothGatt: BluetoothGatt? = null
    private var basControlPoint: BluetoothGattCharacteristic? = null
    private var receiveStateCharacteristics = mutableListOf<BluetoothGattCharacteristic>()
    
    private val _state = MutableStateFlow<BassState>(BassState.Disconnected)
    val state: StateFlow<BassState> = _state.asStateFlow()
    
    private val _receiveStates = MutableStateFlow<List<BroadcastReceiveState>>(emptyList())
    val receiveStates: StateFlow<List<BroadcastReceiveState>> = _receiveStates.asStateFlow()

    private val pendingWrites = ConcurrentHashMap<Int, CompletableDeferred<Boolean>>()
    private var writeRequestId = 0

    private val gattCallback = object : BluetoothGattCallback() {
        override fun onConnectionStateChange(gatt: BluetoothGatt, status: Int, newState: Int) {
            when (newState) {
                BluetoothProfile.STATE_CONNECTED -> {
                    _state.value = BassState.Connecting
                    gatt.discoverServices()
                }
                BluetoothProfile.STATE_DISCONNECTED -> {
                    _state.value = BassState.Disconnected
                    cleanup()
                }
            }
        }

        override fun onServicesDiscovered(gatt: BluetoothGatt, status: Int) {
            if (status != BluetoothGatt.GATT_SUCCESS) {
                _state.value = BassState.Error("Service discovery failed: $status")
                return
            }

            val bassService = gatt.getService(BluetoothUuids.BASS_SERVICE)
            if (bassService == null) {
                _state.value = BassState.Error("BASS service not found on device")
                return
            }

            // Get Control Point
            basControlPoint = bassService.getCharacteristic(
                BluetoothUuids.BROADCAST_AUDIO_SCAN_CONTROL_POINT
            )

            // Get all Broadcast Receive State characteristics
            receiveStateCharacteristics.clear()
            bassService.characteristics.forEach { char ->
                if (char.uuid == BluetoothUuids.BROADCAST_RECEIVE_STATE) {
                    receiveStateCharacteristics.add(char)
                    enableNotifications(gatt, char)
                }
            }

            _state.value = BassState.Connected
        }

        override fun onCharacteristicChanged(
            gatt: BluetoothGatt,
            characteristic: BluetoothGattCharacteristic,
            value: ByteArray
        ) {
            if (characteristic.uuid == BluetoothUuids.BROADCAST_RECEIVE_STATE) {
                parseReceiveState(value)?.let { newState ->
                    val currentStates = _receiveStates.value.toMutableList()
                    val existingIndex = currentStates.indexOfFirst { 
                        it.sourceId == newState.sourceId 
                    }
                    if (existingIndex >= 0) {
                        currentStates[existingIndex] = newState
                    } else {
                        currentStates.add(newState)
                    }
                    _receiveStates.value = currentStates
                    
                    // Update state based on sync status
                    if (newState.paSyncState == PaSyncState.SYNCED) {
                        val syncedBis = newState.subgroups
                            .flatMapIndexed { idx, sg -> 
                                (0..30).filter { (sg.bisSync and (1L shl it)) != 0L }
                                    .map { it + 1 }
                            }
                        _state.value = BassState.Synced(newState.sourceId, syncedBis)
                    }
                }
            }
        }

        override fun onCharacteristicWrite(
            gatt: BluetoothGatt,
            characteristic: BluetoothGattCharacteristic,
            status: Int
        ) {
            val success = status == BluetoothGatt.GATT_SUCCESS
            pendingWrites.values.firstOrNull()?.complete(success)
        }
    }

    fun connect(device: BluetoothDevice): Boolean {
        _state.value = BassState.Connecting
        bluetoothGatt = device.connectGatt(
            context,
            false,
            gattCallback,
            BluetoothDevice.TRANSPORT_LE
        )
        return bluetoothGatt != null
    }

    suspend fun addSource(
        broadcast: DiscoveredBroadcast,
        paSyncEnabled: Boolean = true,
        bisIndices: List<Int> = listOf(1),  // Default: first BIS
        broadcastCode: ByteArray? = null
    ): Result<Int> = withContext(Dispatchers.IO) {
        val controlPoint = basControlPoint 
            ?: return@withContext Result.failure(Exception("Not connected to BASS"))
        
        val gatt = bluetoothGatt 
            ?: return@withContext Result.failure(Exception("GATT not available"))

        // Build Add Source command
        val command = buildAddSourceCommand(
            broadcast = broadcast,
            paSyncEnabled = paSyncEnabled,
            bisIndices = bisIndices
        )

        val deferred = CompletableDeferred<Boolean>()
        pendingWrites[++writeRequestId] = deferred

        controlPoint.value = command
        controlPoint.writeType = BluetoothGattCharacteristic.WRITE_TYPE_DEFAULT
        
        if (!gatt.writeCharacteristic(controlPoint)) {
            pendingWrites.remove(writeRequestId)
            return@withContext Result.failure(Exception("Failed to write to control point"))
        }

        val success = withTimeoutOrNull(5000) { deferred.await() } ?: false
        pendingWrites.remove(writeRequestId)

        if (success) {
            // Source IDã¯æ¬¡ã®Receive State notificationã§å–å¾—
            Result.success(0)
        } else {
            Result.failure(Exception("Add source operation failed"))
        }
    }

    suspend fun setBroadcastCode(sourceId: Int, code: ByteArray): Result<Unit> = 
        withContext(Dispatchers.IO) {
            val controlPoint = basControlPoint 
                ?: return@withContext Result.failure(Exception("Not connected"))
            
            val gatt = bluetoothGatt 
                ?: return@withContext Result.failure(Exception("GATT not available"))

            // Opcode 0x04: Set Broadcast_Code
            val command = ByteArray(18).apply {
                this[0] = 0x04  // Set Broadcast_Code opcode
                this[1] = sourceId.toByte()
                code.copyInto(this, 2, 0, minOf(code.size, 16))
            }

            val deferred = CompletableDeferred<Boolean>()
            pendingWrites[++writeRequestId] = deferred

            controlPoint.value = command
            if (!gatt.writeCharacteristic(controlPoint)) {
                pendingWrites.remove(writeRequestId)
                return@withContext Result.failure(Exception("Failed to write broadcast code"))
            }

            val success = withTimeoutOrNull(5000) { deferred.await() } ?: false
            pendingWrites.remove(writeRequestId)

            if (success) Result.success(Unit)
            else Result.failure(Exception("Set broadcast code failed"))
        }

    suspend fun removeSource(sourceId: Int): Result<Unit> = withContext(Dispatchers.IO) {
        val controlPoint = basControlPoint 
            ?: return@withContext Result.failure(Exception("Not connected"))
        
        val gatt = bluetoothGatt 
            ?: return@withContext Result.failure(Exception("GATT not available"))

        // Opcode 0x05: Remove Source
        val command = byteArrayOf(0x05, sourceId.toByte())

        val deferred = CompletableDeferred<Boolean>()
        pendingWrites[++writeRequestId] = deferred

        controlPoint.value = command
        if (!gatt.writeCharacteristic(controlPoint)) {
            pendingWrites.remove(writeRequestId)
            return@withContext Result.failure(Exception("Failed to write remove command"))
        }

        val success = withTimeoutOrNull(5000) { deferred.await() } ?: false
        pendingWrites.remove(writeRequestId)

        if (success) {
            _receiveStates.value = _receiveStates.value.filter { it.sourceId != sourceId }
            Result.success(Unit)
        } else {
            Result.failure(Exception("Remove source failed"))
        }
    }

    fun disconnect() {
        bluetoothGatt?.disconnect()
    }

    private fun cleanup() {
        bluetoothGatt?.close()
        bluetoothGatt = null
        basControlPoint = null
        receiveStateCharacteristics.clear()
        _receiveStates.value = emptyList()
    }

    private fun enableNotifications(gatt: BluetoothGatt, characteristic: BluetoothGattCharacteristic) {
        gatt.setCharacteristicNotification(characteristic, true)
        characteristic.getDescriptor(BluetoothUuids.CCCD)?.let { descriptor ->
            descriptor.value = BluetoothGattDescriptor.ENABLE_NOTIFICATION_VALUE
            gatt.writeDescriptor(descriptor)
        }
    }

    private fun buildAddSourceCommand(
        broadcast: DiscoveredBroadcast,
        paSyncEnabled: Boolean,
        bisIndices: List<Int>
    ): ByteArray {
        val addressBytes = broadcast.address.split(":")
            .map { it.toInt(16).toByte() }
            .reversed()
            .toByteArray()

        // Calculate BIS_Sync bitmask
        val bisSync = bisIndices.fold(0L) { acc, idx -> acc or (1L shl (idx - 1)) }

        return ByteArray(20).apply {
            var offset = 0
            
            // Opcode: Add Source (0x02)
            this[offset++] = 0x02
            
            // Advertiser_Address_Type
            this[offset++] = broadcast.addressType.toByte()
            
            // Advertiser_Address (6 bytes, little-endian)
            addressBytes.copyInto(this, offset)
            offset += 6
            
            // Advertising_SID
            this[offset++] = broadcast.advertisingSid.toByte()
            
            // Broadcast_ID (3 bytes, little-endian)
            this[offset++] = (broadcast.broadcastId and 0xFF).toByte()
            this[offset++] = ((broadcast.broadcastId shr 8) and 0xFF).toByte()
            this[offset++] = ((broadcast.broadcastId shr 16) and 0xFF).toByte()
            
            // PA_Sync
            this[offset++] = if (paSyncEnabled) 0x01 else 0x00
            
            // PA_Interval (unknown = 0xFFFF)
            this[offset++] = 0xFF.toByte()
            this[offset++] = 0xFF.toByte()
            
            // Num_Subgroups
            this[offset++] = 0x01
            
            // Subgroup[0]: BIS_Sync (4 bytes)
            this[offset++] = (bisSync and 0xFF).toByte()
            this[offset++] = ((bisSync shr 8) and 0xFF).toByte()
            this[offset++] = ((bisSync shr 16) and 0xFF).toByte()
            this[offset++] = ((bisSync shr 24) and 0xFF).toByte()
            
            // Subgroup[0]: Metadata_Length
            this[offset++] = 0x00
        }
    }

    private fun parseReceiveState(data: ByteArray): BroadcastReceiveState? {
        if (data.size < 15) return null
        
        var offset = 0
        
        val sourceId = data[offset++].toInt() and 0xFF
        val addressType = data[offset++].toInt() and 0xFF
        
        val address = (0 until 6).map { 
            String.format("%02X", data[offset + 5 - it]) 
        }.joinToString(":")
        offset += 6
        
        val advSid = data[offset++].toInt() and 0xFF
        
        val broadcastId = (data[offset].toInt() and 0xFF) or
                         ((data[offset + 1].toInt() and 0xFF) shl 8) or
                         ((data[offset + 2].toInt() and 0xFF) shl 16)
        offset += 3
        
        val paSyncState = PaSyncState.fromValue(data[offset++].toInt() and 0xFF)
        val bigEncryption = BigEncryption.fromValue(data[offset++].toInt() and 0xFF)
        
        // Parse subgroups if present
        val subgroups = mutableListOf<SubgroupState>()
        if (offset < data.size) {
            val numSubgroups = data[offset++].toInt() and 0xFF
            repeat(numSubgroups) {
                if (offset + 5 <= data.size) {
                    val bisSync = (data[offset].toLong() and 0xFF) or
                                 ((data[offset + 1].toLong() and 0xFF) shl 8) or
                                 ((data[offset + 2].toLong() and 0xFF) shl 16) or
                                 ((data[offset + 3].toLong() and 0xFF) shl 24)
                    offset += 4
                    
                    val metadataLen = data[offset++].toInt() and 0xFF
                    val metadata = if (metadataLen > 0 && offset + metadataLen <= data.size) {
                        data.copyOfRange(offset, offset + metadataLen).also { offset += metadataLen }
                    } else ByteArray(0)
                    
                    subgroups.add(SubgroupState(bisSync, metadataLen, metadata))
                }
            }
        }

        return BroadcastReceiveState(
            sourceId = sourceId,
            sourceAddress = address,
            sourceAddressType = addressType,
            advertisingSid = advSid,
            broadcastId = broadcastId,
            paSyncState = paSyncState,
            bigEncryption = bigEncryption,
            subgroups = subgroups
        )
    }
}
```

### 5.4 Flutter Method Channel Plugin

```kotlin
// plugins/AuracastPlugin.kt
package com.denon.auracast.plugins

import android.bluetooth.BluetoothAdapter
import android.bluetooth.BluetoothManager
import android.content.Context
import com.denon.auracast.bluetooth.*
import io.flutter.embedding.engine.plugins.FlutterPlugin
import io.flutter.plugin.common.EventChannel
import io.flutter.plugin.common.MethodChannel
import kotlinx.coroutines.*
import kotlinx.coroutines.flow.collect

class AuracastPlugin : FlutterPlugin {
    private lateinit var methodChannel: MethodChannel
    private lateinit var scanEventChannel: EventChannel
    private lateinit var stateEventChannel: EventChannel
    
    private lateinit var context: Context
    private lateinit var bluetoothAdapter: BluetoothAdapter
    
    private var scanner: AuracastScanner? = null
    private var bassManager: BassGattManager? = null
    
    private val scope = CoroutineScope(Dispatchers.Main + SupervisorJob())
    private var scanJob: Job? = null

    override fun onAttachedToEngine(binding: FlutterPlugin.FlutterPluginBinding) {
        context = binding.applicationContext
        val bluetoothManager = context.getSystemService(Context.BLUETOOTH_SERVICE) as BluetoothManager
        bluetoothAdapter = bluetoothManager.adapter
        
        scanner = AuracastScanner(bluetoothAdapter)
        bassManager = BassGattManager(context)

        methodChannel = MethodChannel(binding.binaryMessenger, "com.denon.auracast/method")
        methodChannel.setMethodCallHandler { call, result ->
            when (call.method) {
                "isLeAudioSupported" -> {
                    result.success(isLeAudioSupported())
                }
                "startScan" -> {
                    startScan()
                    result.success(null)
                }
                "stopScan" -> {
                    stopScan()
                    result.success(null)
                }
                "connectToSink" -> {
                    val address = call.argument<String>("address")!!
                    scope.launch {
                        val device = bluetoothAdapter.getRemoteDevice(address)
                        val success = bassManager?.connect(device) ?: false
                        result.success(success)
                    }
                }
                "addSource" -> {
                    val sourceAddress = call.argument<String>("sourceAddress")!!
                    val addressType = call.argument<Int>("addressType") ?: 0
                    val broadcastId = call.argument<Int>("broadcastId")!!
                    val advertisingSid = call.argument<Int>("advertisingSid")!!
                    val broadcastCode = call.argument<ByteArray>("broadcastCode")
                    
                    scope.launch {
                        val broadcast = DiscoveredBroadcast(
                            address = sourceAddress,
                            addressType = addressType,
                            name = null,
                            rssi = 0,
                            broadcastId = broadcastId,
                            advertisingSid = advertisingSid,
                            baseData = null,
                            isEncrypted = broadcastCode != null
                        )
                        
                        bassManager?.addSource(broadcast)?.fold(
                            onSuccess = { result.success(true) },
                            onFailure = { result.error("ADD_SOURCE_FAILED", it.message, null) }
                        )
                    }
                }
                "removeSource" -> {
                    val sourceId = call.argument<Int>("sourceId")!!
                    scope.launch {
                        bassManager?.removeSource(sourceId)?.fold(
                            onSuccess = { result.success(true) },
                            onFailure = { result.error("REMOVE_FAILED", it.message, null) }
                        )
                    }
                }
                "disconnect" -> {
                    bassManager?.disconnect()
                    result.success(null)
                }
                else -> result.notImplemented()
            }
        }

        scanEventChannel = EventChannel(binding.binaryMessenger, "com.denon.auracast/scan")
        scanEventChannel.setStreamHandler(object : EventChannel.StreamHandler {
            private var eventSink: EventChannel.EventSink? = null
            
            override fun onListen(arguments: Any?, events: EventChannel.EventSink?) {
                eventSink = events
                scanJob = scope.launch {
                    scanner?.startScan()?.collect { broadcast ->
                        eventSink?.success(mapOf(
                            "address" to broadcast.address,
                            "addressType" to broadcast.addressType,
                            "name" to broadcast.name,
                            "rssi" to broadcast.rssi,
                            "broadcastId" to broadcast.broadcastId,
                            "advertisingSid" to broadcast.advertisingSid,
                            "isEncrypted" to broadcast.isEncrypted
                        ))
                    }
                }
            }
            
            override fun onCancel(arguments: Any?) {
                scanJob?.cancel()
                eventSink = null
            }
        })

        stateEventChannel = EventChannel(binding.binaryMessenger, "com.denon.auracast/state")
        stateEventChannel.setStreamHandler(object : EventChannel.StreamHandler {
            private var stateJob: Job? = null
            
            override fun onListen(arguments: Any?, events: EventChannel.EventSink?) {
                stateJob = scope.launch {
                    bassManager?.state?.collect { state ->
                        events?.success(when (state) {
                            is BassState.Disconnected -> mapOf("state" to "disconnected")
                            is BassState.Connecting -> mapOf("state" to "connecting")
                            is BassState.Connected -> mapOf("state" to "connected")
                            is BassState.SourceAdded -> mapOf(
                                "state" to "sourceAdded",
                                "sourceId" to state.sourceId
                            )
                            is BassState.Synced -> mapOf(
                                "state" to "synced",
                                "sourceId" to state.sourceId,
                                "bisIndices" to state.bisIndices
                            )
                            is BassState.Error -> mapOf(
                                "state" to "error",
                                "message" to state.message
                            )
                        })
                    }
                }
            }
            
            override fun onCancel(arguments: Any?) {
                stateJob?.cancel()
            }
        })
    }

    override fun onDetachedFromEngine(binding: FlutterPlugin.FlutterPluginBinding) {
        scope.cancel()
        methodChannel.setMethodCallHandler(null)
    }

    private fun isLeAudioSupported(): Boolean {
        return android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.TIRAMISU &&
               bluetoothAdapter.isLeAudioBroadcastSourceSupported == 
                   android.bluetooth.BluetoothStatusCodes.FEATURE_SUPPORTED
    }

    private fun startScan() {
        // Scan is started via EventChannel listener
    }

    private fun stopScan() {
        scanJob?.cancel()
        scanner?.stopScan()
    }
}
```

---

## 6. Flutterå®Ÿè£…ã‚³ãƒ¼ãƒ‰

### 6.1 Method Channel (Dartå´)

```dart
// lib/services/auracast_channel.dart
import 'dart:async';
import 'dart:typed_data';
import 'package:flutter/services.dart';

class AuracastChannel {
  static const _methodChannel = MethodChannel('com.denon.auracast/method');
  static const _scanEventChannel = EventChannel('com.denon.auracast/scan');
  static const _stateEventChannel = EventChannel('com.denon.auracast/state');

  Future<bool> isLeAudioSupported() async {
    try {
      return await _methodChannel.invokeMethod<bool>('isLeAudioSupported') ?? false;
    } on PlatformException {
      return false;
    }
  }

  Stream<DiscoveredBroadcast> get scanStream =>
      _scanEventChannel.receiveBroadcastStream().map(
        (event) => DiscoveredBroadcast.fromMap(Map<String, dynamic>.from(event)),
      );

  Stream<BassConnectionState> get stateStream =>
      _stateEventChannel.receiveBroadcastStream().map(
        (event) => BassConnectionState.fromMap(Map<String, dynamic>.from(event)),
      );

  Future<void> startScan() async {
    await _methodChannel.invokeMethod('startScan');
  }

  Future<void> stopScan() async {
    await _methodChannel.invokeMethod('stopScan');
  }

  Future<bool> connectToSink(String address) async {
    return await _methodChannel.invokeMethod<bool>('connectToSink', {
      'address': address,
    }) ?? false;
  }

  Future<bool> addSource({
    required String sourceAddress,
    required int addressType,
    required int broadcastId,
    required int advertisingSid,
    Uint8List? broadcastCode,
  }) async {
    try {
      return await _methodChannel.invokeMethod<bool>('addSource', {
        'sourceAddress': sourceAddress,
        'addressType': addressType,
        'broadcastId': broadcastId,
        'advertisingSid': advertisingSid,
        'broadcastCode': broadcastCode,
      }) ?? false;
    } on PlatformException catch (e) {
      throw AuracastException(e.message ?? 'Failed to add source');
    }
  }

  Future<bool> removeSource(int sourceId) async {
    try {
      return await _methodChannel.invokeMethod<bool>('removeSource', {
        'sourceId': sourceId,
      }) ?? false;
    } on PlatformException catch (e) {
      throw AuracastException(e.message ?? 'Failed to remove source');
    }
  }

  Future<void> disconnect() async {
    await _methodChannel.invokeMethod('disconnect');
  }
}

class DiscoveredBroadcast {
  final String address;
  final int addressType;
  final String? name;
  final int rssi;
  final int broadcastId;
  final int advertisingSid;
  final bool isEncrypted;

  DiscoveredBroadcast({
    required this.address,
    required this.addressType,
    this.name,
    required this.rssi,
    required this.broadcastId,
    required this.advertisingSid,
    required this.isEncrypted,
  });

  factory DiscoveredBroadcast.fromMap(Map<String, dynamic> map) {
    return DiscoveredBroadcast(
      address: map['address'] as String,
      addressType: map['addressType'] as int,
      name: map['name'] as String?,
      rssi: map['rssi'] as int,
      broadcastId: map['broadcastId'] as int,
      advertisingSid: map['advertisingSid'] as int,
      isEncrypted: map['isEncrypted'] as bool,
    );
  }

  String get displayName => name ?? 'Broadcast ${broadcastId.toRadixString(16).toUpperCase()}';
}

sealed class BassConnectionState {
  factory BassConnectionState.fromMap(Map<String, dynamic> map) {
    return switch (map['state']) {
      'disconnected' => BassDisconnected(),
      'connecting' => BassConnecting(),
      'connected' => BassConnected(),
      'sourceAdded' => BassSourceAdded(sourceId: map['sourceId'] as int),
      'synced' => BassSynced(
          sourceId: map['sourceId'] as int,
          bisIndices: List<int>.from(map['bisIndices']),
        ),
      'error' => BassError(message: map['message'] as String),
      _ => BassDisconnected(),
    };
  }
}

class BassDisconnected implements BassConnectionState {}
class BassConnecting implements BassConnectionState {}
class BassConnected implements BassConnectionState {}
class BassSourceAdded implements BassConnectionState {
  final int sourceId;
  BassSourceAdded({required this.sourceId});
}
class BassSynced implements BassConnectionState {
  final int sourceId;
  final List<int> bisIndices;
  BassSynced({required this.sourceId, required this.bisIndices});
}
class BassError implements BassConnectionState {
  final String message;
  BassError({required this.message});
}

class AuracastException implements Exception {
  final String message;
  AuracastException(this.message);
  
  @override
  String toString() => 'AuracastException: $message';
}
```

### 6.2 Riverpod Provider

```dart
// lib/presentation/providers/auracast_provider.dart
import 'dart:async';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:riverpod_annotation/riverpod_annotation.dart';
import '../../services/auracast_channel.dart';

part 'auracast_provider.g.dart';

@riverpod
AuracastChannel auracastChannel(Ref ref) => AuracastChannel();

@riverpod
class AuracastNotifier extends _$AuracastNotifier {
  StreamSubscription? _scanSubscription;
  StreamSubscription? _stateSubscription;

  @override
  AuracastState build() {
    ref.onDispose(() {
      _scanSubscription?.cancel();
      _stateSubscription?.cancel();
    });
    
    _listenToState();
    return const AuracastState();
  }

  void _listenToState() {
    final channel = ref.read(auracastChannelProvider);
    _stateSubscription = channel.stateStream.listen((bassState) {
      state = state.copyWith(connectionState: bassState);
    });
  }

  Future<void> checkSupport() async {
    final channel = ref.read(auracastChannelProvider);
    final supported = await channel.isLeAudioSupported();
    state = state.copyWith(isSupported: supported);
  }

  Future<void> startScanning() async {
    final channel = ref.read(auracastChannelProvider);
    
    state = state.copyWith(
      isScanning: true,
      discoveredBroadcasts: [],
    );

    _scanSubscription = channel.scanStream.listen(
      (broadcast) {
        final existing = state.discoveredBroadcasts;
        final index = existing.indexWhere((b) => b.address == broadcast.address);
        
        final updated = index >= 0
            ? [...existing]..[index] = broadcast
            : [...existing, broadcast];
        
        // Sort by RSSI (strongest first)
        updated.sort((a, b) => b.rssi.compareTo(a.rssi));
        
        state = state.copyWith(discoveredBroadcasts: updated);
      },
      onError: (error) {
        state = state.copyWith(
          isScanning: false,
          error: error.toString(),
        );
      },
    );
  }

  Future<void> stopScanning() async {
    final channel = ref.read(auracastChannelProvider);
    await channel.stopScan();
    _scanSubscription?.cancel();
    state = state.copyWith(isScanning: false);
  }

  Future<void> connectToSink(String sinkAddress) async {
    final channel = ref.read(auracastChannelProvider);
    state = state.copyWith(connectedSinkAddress: sinkAddress);
    await channel.connectToSink(sinkAddress);
  }

  Future<void> addSourceToSink(DiscoveredBroadcast broadcast) async {
    final channel = ref.read(auracastChannelProvider);
    
    try {
      await channel.addSource(
        sourceAddress: broadcast.address,
        addressType: broadcast.addressType,
        broadcastId: broadcast.broadcastId,
        advertisingSid: broadcast.advertisingSid,
      );
      state = state.copyWith(currentBroadcast: broadcast);
    } catch (e) {
      state = state.copyWith(error: e.toString());
    }
  }

  Future<void> removeCurrentSource() async {
    final channel = ref.read(auracastChannelProvider);
    final currentState = state.connectionState;
    
    if (currentState is BassSynced) {
      await channel.removeSource(currentState.sourceId);
      state = state.copyWith(currentBroadcast: null);
    }
  }

  Future<void> disconnect() async {
    final channel = ref.read(auracastChannelProvider);
    await channel.disconnect();
    state = state.copyWith(
      connectedSinkAddress: null,
      currentBroadcast: null,
    );
  }
}

class AuracastState {
  final bool isSupported;
  final bool isScanning;
  final List<DiscoveredBroadcast> discoveredBroadcasts;
  final String? connectedSinkAddress;
  final DiscoveredBroadcast? currentBroadcast;
  final BassConnectionState connectionState;
  final String? error;

  const AuracastState({
    this.isSupported = false,
    this.isScanning = false,
    this.discoveredBroadcasts = const [],
    this.connectedSinkAddress,
    this.currentBroadcast,
    this.connectionState = const _InitialBassState(),
    this.error,
  });

  AuracastState copyWith({
    bool? isSupported,
    bool? isScanning,
    List<DiscoveredBroadcast>? discoveredBroadcasts,
    String? connectedSinkAddress,
    DiscoveredBroadcast? currentBroadcast,
    BassConnectionState? connectionState,
    String? error,
  }) {
    return AuracastState(
      isSupported: isSupported ?? this.isSupported,
      isScanning: isScanning ?? this.isScanning,
      discoveredBroadcasts: discoveredBroadcasts ?? this.discoveredBroadcasts,
      connectedSinkAddress: connectedSinkAddress ?? this.connectedSinkAddress,
      currentBroadcast: currentBroadcast ?? this.currentBroadcast,
      connectionState: connectionState ?? this.connectionState,
      error: error,
    );
  }
}

class _InitialBassState implements BassConnectionState {
  const _InitialBassState();
}
```

---

## 7. pubspec.yaml

```yaml
name: denon_auracast
description: Denon TWS Auracast Assistant App
version: 1.0.0+1

environment:
  sdk: '>=3.2.0 <4.0.0'

dependencies:
  flutter:
    sdk: flutter
  
  # State Management
  flutter_riverpod: ^2.5.1
  riverpod_annotation: ^2.3.5
  
  # Local Storage
  hive: ^2.2.3
  hive_flutter: ^1.1.0
  flutter_secure_storage: ^9.2.2
  
  # AWS Amplify
  amplify_flutter: ^2.0.0
  amplify_auth_cognito: ^2.0.0
  amplify_api: ^2.0.0
  
  # Permissions
  permission_handler: ^11.3.1
  
  # UI
  google_fonts: ^6.2.1
  
  # Utilities
  equatable: ^2.0.5
  uuid: ^4.4.2

dev_dependencies:
  flutter_test:
    sdk: flutter
  flutter_lints: ^3.0.0
  build_runner: ^2.4.9
  riverpod_generator: ^2.4.0
  hive_generator: ^2.0.1

flutter:
  uses-material-design: true
```

---

## 8. DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«è¨­è¨ˆï¼ˆSingle-Table Designï¼‰

### 8.1 ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ¼ãƒ

```
Table Name: auracast-main
Region: ap-northeast-1

Primary Key:
  - PK (Partition Key): String
  - SK (Sort Key): String

Global Secondary Indexes:
  - GSI1: GSI1PK (PK), GSI1SK (SK) - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥ã‚¯ã‚¨ãƒªç”¨
  - GSI2: GSI2PK (PK), GSI2SK (SK) - ä½ç½®æƒ…å ±æ¤œç´¢ç”¨

Billing Mode: PAY_PER_REQUEST (On-Demand)
Point-in-Time Recovery: Enabled
```

### 8.2 ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PK             â”‚ SK                      â”‚ Attributes                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ USER#12345     â”‚ PROFILE                 â”‚ name, email, createdAt           â”‚
â”‚ USER#12345     â”‚ DEVICE#dev_001          â”‚ deviceType, name, lastSeen       â”‚
â”‚ USER#12345     â”‚ FAVORITE#bc_001         â”‚ broadcastId, addedAt             â”‚
â”‚ USER#12345     â”‚ HISTORY#2024-12-18      â”‚ broadcastId, duration, timestamp â”‚
â”‚ USER#12345     â”‚ PREFERENCE              â”‚ categories, languages, settings  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BROADCAST#bc_001â”‚ META                   â”‚ name, language, quality, locationâ”‚
â”‚ BROADCAST#bc_001â”‚ SCHEDULE#2024-12-18   â”‚ startTime, endTime, description  â”‚
â”‚ BROADCAST#bc_001â”‚ STATS                  â”‚ totalListeners, avgRating, etc   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ REVIEW#rev_001 â”‚ META                    â”‚ userId, broadcastId, rating, textâ”‚
â”‚ REVIEW#rev_001 â”‚ SENTIMENT               â”‚ score, magnitude, categories     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ VENUE#venue_001â”‚ META                    â”‚ name, address, coordinates       â”‚
â”‚ VENUE#venue_001â”‚ BROADCAST#bc_001       â”‚ broadcastId, position, active    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ GEO#35.6812#139â”‚ BROADCAST#bc_001       â”‚ broadcastId, geohash, distance   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.3 è¿½åŠ GSIè¨­è¨ˆ

```
GSI3: å£ã‚³ãƒŸæ¤œç´¢ç”¨
  - GSI3PK: BROADCAST#{broadcastId}
  - GSI3SK: REVIEW#{timestamp}
  - ç”¨é€”: ç‰¹å®šãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§å–å¾—

GSI4: ä½ç½®æƒ…å ±æ¤œç´¢ç”¨ï¼ˆGeohashï¼‰
  - GSI4PK: GEOHASH#{geohash_prefix}
  - GSI4SK: {broadcastId}
  - ç”¨é€”: è¿‘éš£ãƒãƒ£ãƒ³ãƒãƒ«æ¤œç´¢

GSI5: äººæ°—ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨
  - GSI5PK: CATEGORY#{category}
  - GSI5SK: RANK#{score}#{broadcastId}
  - ç”¨é€”: ã‚«ãƒ†ã‚´ãƒªåˆ¥äººæ°—ãƒ©ãƒ³ã‚­ãƒ³ã‚°
```

---

## 9. ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æ©Ÿèƒ½è©³ç´°è¨­è¨ˆ

### 9.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»èªè¨¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Flutter   â”‚â”€â”€â”€â–ºâ”‚  Cognito    â”‚â”€â”€â”€â–ºâ”‚  Lambda     â”‚â”€â”€â”€â–ºâ”‚  DynamoDB   â”‚     â”‚
â”‚  â”‚    App      â”‚    â”‚ User Pools  â”‚    â”‚ Post-Confirmâ”‚    â”‚  User Table â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  Trigger    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                 â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚             â”‚
â”‚         â”‚                 â”‚                   â”‚                  â”‚             â”‚
â”‚         â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚         â”‚           â”‚  Identity   â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ EventBridge â”‚     â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚    Pool     â”‚                        â”‚ User Events â”‚     â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.1.1 Cognito User Pool è¨­å®š

```typescript
// infrastructure/lib/constructs/auth-construct.ts
const userPool = new cognito.UserPool(this, 'AuracastUserPool', {
  userPoolName: 'auracast-users',
  selfSignUpEnabled: true,
  signInAliases: {
    email: true,
    phone: true,
  },
  autoVerify: {
    email: true,
  },
  standardAttributes: {
    email: { required: true, mutable: true },
    nickname: { required: false, mutable: true },
    locale: { required: false, mutable: true },
  },
  customAttributes: {
    'preferred_categories': new cognito.StringAttribute({ mutable: true }),
    'preferred_languages': new cognito.StringAttribute({ mutable: true }),
  },
  passwordPolicy: {
    minLength: 8,
    requireLowercase: true,
    requireUppercase: true,
    requireDigits: true,
    requireSymbols: false,
  },
  accountRecovery: cognito.AccountRecovery.EMAIL_ONLY,
  mfa: cognito.Mfa.OPTIONAL,
  mfaSecondFactor: {
    sms: true,
    otp: true,
  },
});

// ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³è¨­å®š
const googleProvider = new cognito.UserPoolIdentityProviderGoogle(this, 'Google', {
  clientId: process.env.GOOGLE_CLIENT_ID!,
  clientSecret: SecretValue.secretsManager('google-oauth-secret'),
  userPool,
  scopes: ['email', 'profile'],
  attributeMapping: {
    email: cognito.ProviderAttribute.GOOGLE_EMAIL,
    nickname: cognito.ProviderAttribute.GOOGLE_NAME,
  },
});

const appleProvider = new cognito.UserPoolIdentityProviderApple(this, 'Apple', {
  clientId: process.env.APPLE_CLIENT_ID!,
  teamId: process.env.APPLE_TEAM_ID!,
  keyId: process.env.APPLE_KEY_ID!,
  privateKey: SecretValue.secretsManager('apple-private-key'),
  userPool,
  scopes: ['email', 'name'],
});
```

#### 9.1.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ« Lambda

```python
# lambda/users/post_confirmation.py
import boto3
import json
from datetime import datetime
import uuid

dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('auracast-main')
eventbridge = boto3.client('events')

def handler(event, context):
    """Cognito Post Confirmation Trigger - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ"""

    user_attributes = event['request']['userAttributes']
    user_id = event['userName']

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
    profile_item = {
        'PK': f'USER#{user_id}',
        'SK': 'PROFILE',
        'userId': user_id,
        'email': user_attributes.get('email'),
        'nickname': user_attributes.get('nickname', ''),
        'locale': user_attributes.get('locale', 'ja-JP'),
        'createdAt': datetime.utcnow().isoformat(),
        'updatedAt': datetime.utcnow().isoformat(),
        'status': 'ACTIVE',
        'GSI1PK': 'USERS',
        'GSI1SK': f'CREATED#{datetime.utcnow().isoformat()}',
    }

    # ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šåˆæœŸåŒ–
    preference_item = {
        'PK': f'USER#{user_id}',
        'SK': 'PREFERENCE',
        'preferredCategories': [],
        'preferredLanguages': ['ja'],
        'notificationEnabled': True,
        'autoPlayEnabled': False,
        'dataCollectionConsent': True,
    }

    # ãƒãƒƒãƒæ›¸ãè¾¼ã¿
    with table.batch_writer() as batch:
        batch.put_item(Item=profile_item)
        batch.put_item(Item=preference_item)

    # EventBridge ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
    eventbridge.put_events(
        Entries=[{
            'Source': 'auracast.users',
            'DetailType': 'UserRegistered',
            'Detail': json.dumps({
                'userId': user_id,
                'email': user_attributes.get('email'),
                'timestamp': datetime.utcnow().isoformat(),
            }),
            'EventBusName': 'auracast-events',
        }]
    )

    return event
```

#### 9.1.3 ãƒ¦ãƒ¼ã‚¶ãƒ¼ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|---------------|---------|------|
| `/users/me` | GET | è‡ªåˆ†ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å–å¾— |
| `/users/me` | PUT | ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–° |
| `/users/me/preferences` | GET/PUT | è¨­å®šå–å¾—ãƒ»æ›´æ–° |
| `/users/me/devices` | GET/POST/DELETE | ãƒ‡ãƒã‚¤ã‚¹ç®¡ç† |
| `/users/me/history` | GET | è¦–è´å±¥æ­´å–å¾— |
| `/users/me/favorites` | GET/POST/DELETE | ãŠæ°—ã«å…¥ã‚Šç®¡ç† |

---

### 9.2 ãƒãƒ£ãƒ³ãƒãƒ«åˆ†æãƒ»ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ãƒãƒ£ãƒ³ãƒãƒ«ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Flutter   â”‚â”€â”€â”€â–ºâ”‚  Kinesis    â”‚â”€â”€â”€â–ºâ”‚  Lambda     â”‚â”€â”€â”€â–ºâ”‚    S3       â”‚             â”‚
â”‚  â”‚ ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡ â”‚    â”‚Data Streams â”‚    â”‚ ETLå‡¦ç†     â”‚    â”‚ Data Lake   â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                     â”‚                  â”‚                     â”‚
â”‚         â”‚                                     â–¼                  â–¼                     â”‚
â”‚         â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚                             â”‚ Personalize â”‚â—„â”€â”€â”€â”‚  Glue ETL   â”‚             â”‚
â”‚         â”‚                             â”‚   Dataset   â”‚    â”‚  ãƒ‡ãƒ¼ã‚¿å¤‰æ›  â”‚             â”‚
â”‚         â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                     â”‚                                        â”‚
â”‚         â”‚                                     â–¼                                        â”‚
â”‚  ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰å–å¾—                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ Personalize â”‚                                 â”‚
â”‚  â”‚   Flutter   â”‚â—„â”€â”€â”€â”‚ API Gateway â”‚â—„â”€â”€â”€â”‚  Campaign   â”‚                                 â”‚
â”‚  â”‚ ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰  â”‚    â”‚  /recommend â”‚    â”‚ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ  â”‚                                 â”‚
â”‚  â”‚  è¡¨ç¤º       â”‚    â”‚             â”‚    â”‚   æ¨è–¦      â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.2.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ã‚¤ãƒ™ãƒ³ãƒˆã‚¹ã‚­ãƒ¼ãƒ

```json
{
  "eventType": "CHANNEL_INTERACTION",
  "userId": "user_12345",
  "sessionId": "session_abc",
  "timestamp": "2024-12-18T10:30:00Z",
  "eventName": "LISTEN_START | LISTEN_END | FAVORITE_ADD | SEARCH | VIEW_DETAIL",
  "properties": {
    "broadcastId": "bc_001",
    "broadcastName": "Cafe Jazz BGM",
    "category": "MUSIC",
    "duration": 1800,
    "location": {
      "latitude": 35.6812,
      "longitude": 139.7671,
      "geohash": "xn77h"
    },
    "deviceType": "TWS",
    "signalStrength": -45
  }
}
```

#### 9.2.2 Amazon Personalize è¨­å®š

```typescript
// infrastructure/lib/constructs/personalize-construct.ts

// ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚°ãƒ«ãƒ¼ãƒ—
const datasetGroup = new personalize.CfnDatasetGroup(this, 'AuracastDatasetGroup', {
  name: 'auracast-recommendations',
});

// ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ã‚­ãƒ¼ãƒ
const interactionsSchema = {
  type: 'record',
  name: 'Interactions',
  namespace: 'com.auracast',
  fields: [
    { name: 'USER_ID', type: 'string' },
    { name: 'ITEM_ID', type: 'string' },
    { name: 'TIMESTAMP', type: 'long' },
    { name: 'EVENT_TYPE', type: 'string' },
    { name: 'EVENT_VALUE', type: ['null', 'float'], default: null },
  ],
  version: '1.0',
};

// ã‚¢ã‚¤ãƒ†ãƒ ã‚¹ã‚­ãƒ¼ãƒï¼ˆãƒãƒ£ãƒ³ãƒãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼‰
const itemsSchema = {
  type: 'record',
  name: 'Items',
  namespace: 'com.auracast',
  fields: [
    { name: 'ITEM_ID', type: 'string' },
    { name: 'CATEGORY', type: 'string', categorical: true },
    { name: 'LANGUAGE', type: 'string', categorical: true },
    { name: 'VENUE_TYPE', type: 'string', categorical: true },
    { name: 'AUDIO_QUALITY', type: 'string', categorical: true },
    { name: 'CREATION_TIMESTAMP', type: 'long' },
  ],
  version: '1.0',
};

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¹ã‚­ãƒ¼ãƒ
const usersSchema = {
  type: 'record',
  name: 'Users',
  namespace: 'com.auracast',
  fields: [
    { name: 'USER_ID', type: 'string' },
    { name: 'PREFERRED_CATEGORIES', type: 'string', categorical: true },
    { name: 'PREFERRED_LANGUAGES', type: 'string', categorical: true },
    { name: 'LOCALE', type: 'string', categorical: true },
  ],
  version: '1.0',
};

// ãƒ¬ã‚·ãƒ”é¸æŠ
// - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³: aws-user-personalization-v2
// - é¡ä¼¼ã‚¢ã‚¤ãƒ†ãƒ : aws-similar-items
// - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰: aws-personalized-ranking
```

#### 9.2.3 ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ API Lambda

```python
# lambda/recommendations/get_recommendations.py
import boto3
import json

personalize_runtime = boto3.client('personalize-runtime')
dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('auracast-main')

CAMPAIGN_ARN = 'arn:aws:personalize:ap-northeast-1:xxx:campaign/auracast-user-personalization'

def handler(event, context):
    """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸãƒãƒ£ãƒ³ãƒãƒ«æ¨è–¦ã‚’è¿”ã™"""

    user_id = event['requestContext']['authorizer']['claims']['sub']
    query_params = event.get('queryStringParameters', {}) or {}

    num_results = int(query_params.get('limit', 10))
    category_filter = query_params.get('category')

    # ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¼æ§‹ç¯‰
    filter_arn = None
    if category_filter:
        filter_arn = f'arn:aws:personalize:ap-northeast-1:xxx:filter/category-{category_filter}'

    # Personalize ã‹ã‚‰ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰å–å¾—
    response = personalize_runtime.get_recommendations(
        campaignArn=CAMPAIGN_ARN,
        userId=user_id,
        numResults=num_results,
        filterArn=filter_arn,
        context={
            'DEVICE_TYPE': query_params.get('deviceType', 'UNKNOWN'),
        }
    )

    # ãƒãƒ£ãƒ³ãƒãƒ«è©³ç´°æƒ…å ±ã‚’ DynamoDB ã‹ã‚‰å–å¾—
    item_ids = [item['itemId'] for item in response['itemList']]

    recommendations = []
    for item_id in item_ids:
        channel_response = table.get_item(
            Key={'PK': f'BROADCAST#{item_id}', 'SK': 'META'}
        )
        if 'Item' in channel_response:
            channel = channel_response['Item']
            recommendations.append({
                'broadcastId': item_id,
                'name': channel.get('name'),
                'category': channel.get('category'),
                'language': channel.get('language'),
                'venue': channel.get('venue'),
                'currentListeners': channel.get('currentListeners', 0),
                'avgRating': channel.get('avgRating', 0),
                'score': next(
                    (item['score'] for item in response['itemList'] if item['itemId'] == item_id),
                    0
                )
            })

    return {
        'statusCode': 200,
        'headers': {'Content-Type': 'application/json'},
        'body': json.dumps({
            'recommendations': recommendations,
            'recommendationId': response.get('recommendationId'),
        })
    }
```

#### 9.2.4 ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|---------------|---------|------|
| `/recommendations` | GET | ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºæ¨è–¦å–å¾— |
| `/recommendations/similar/{broadcastId}` | GET | é¡ä¼¼ãƒãƒ£ãƒ³ãƒãƒ«å–å¾— |
| `/recommendations/trending` | GET | ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ³ãƒãƒ« |
| `/recommendations/nearby` | GET | è¿‘éš£äººæ°—ãƒãƒ£ãƒ³ãƒãƒ« |
| `/events` | POST | ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡ |

---

### 9.3 å£ã‚³ãƒŸè©•ä¾¡ãƒ»åˆ†é¡ã‚·ã‚¹ãƒ†ãƒ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            å£ã‚³ãƒŸãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ãƒ•ãƒ­ãƒ¼                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Flutter   â”‚â”€â”€â”€â–ºâ”‚ API Gateway â”‚â”€â”€â”€â–ºâ”‚   Lambda    â”‚â”€â”€â”€â–ºâ”‚  DynamoDB   â”‚             â”‚
â”‚  â”‚ ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿â”‚    â”‚ POST /reviewâ”‚    â”‚ æŠ•ç¨¿å‡¦ç†    â”‚    â”‚ ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¿å­˜ â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                               â”‚                  â”‚                     â”‚
â”‚                                               â–¼                  â”‚                     â”‚
â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                     â”‚
â”‚                                        â”‚ EventBridge â”‚           â”‚                     â”‚
â”‚                                        â”‚ ReviewPostedâ”‚           â”‚                     â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                     â”‚
â”‚                                               â”‚                  â”‚                     â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                     â”‚
â”‚                              â–¼                â–¼                  â–¼                     â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                       â”‚ Comprehend  â”‚  â”‚ OpenSearch  â”‚  â”‚   Lambda    â”‚               â”‚
â”‚                       â”‚ æ„Ÿæƒ…åˆ†æ    â”‚  â”‚ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ â”‚  â”‚ è©•ä¾¡é›†è¨ˆ    â”‚               â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                              â”‚                â”‚                  â”‚                     â”‚
â”‚                              â–¼                â–¼                  â–¼                     â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                       â”‚  DynamoDB   â”‚  â”‚ OpenSearch  â”‚  â”‚  DynamoDB   â”‚               â”‚
â”‚                       â”‚ æ„Ÿæƒ…ã‚¹ã‚³ã‚¢  â”‚  â”‚ æ¤œç´¢å¯èƒ½    â”‚  â”‚ BROADCAST   â”‚               â”‚
â”‚                       â”‚  ä¿å­˜       â”‚  â”‚             â”‚  â”‚ çµ±è¨ˆæ›´æ–°    â”‚               â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.3.1 ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

```typescript
interface Review {
  reviewId: string;           // UUID
  userId: string;             // æŠ•ç¨¿è€…ID
  broadcastId: string;        // å¯¾è±¡ãƒãƒ£ãƒ³ãƒãƒ«
  rating: number;             // 1-5æ˜Ÿè©•ä¾¡
  title: string;              // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆä»»æ„ï¼‰
  content: string;            // ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡
  tags: string[];             // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¿ã‚°ï¼ˆä¾‹: ["éŸ³è³ªè‰¯ã„", "BGMã«æœ€é©"]ï¼‰

  // è‡ªå‹•åˆ†æçµæœ
  sentiment: {
    score: number;            // -1.0 ~ 1.0
    magnitude: number;        // 0 ~ âˆ
    label: 'POSITIVE' | 'NEGATIVE' | 'NEUTRAL' | 'MIXED';
  };
  categories: string[];       // è‡ªå‹•åˆ†é¡ã‚«ãƒ†ã‚´ãƒª
  keyPhrases: string[];       // æŠ½å‡ºã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ã‚º

  // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
  createdAt: string;
  updatedAt: string;
  helpfulCount: number;       // ã€Œå‚è€ƒã«ãªã£ãŸã€æ•°
  reportCount: number;        // å ±å‘Šæ•°
  status: 'ACTIVE' | 'HIDDEN' | 'DELETED';
}
```

#### 9.3.2 ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ Lambda

```python
# lambda/reviews/create_review.py
import boto3
import json
from datetime import datetime
import uuid

dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('auracast-main')
eventbridge = boto3.client('events')

def handler(event, context):
    """ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿å‡¦ç†"""

    user_id = event['requestContext']['authorizer']['claims']['sub']
    body = json.loads(event['body'])

    review_id = str(uuid.uuid4())
    timestamp = datetime.utcnow().isoformat()

    # é‡è¤‡æŠ•ç¨¿ãƒã‚§ãƒƒã‚¯ï¼ˆåŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»åŒä¸€ãƒãƒ£ãƒ³ãƒãƒ«ï¼‰
    existing = table.query(
        IndexName='GSI3',
        KeyConditionExpression='GSI3PK = :pk',
        FilterExpression='userId = :uid',
        ExpressionAttributeValues={
            ':pk': f'BROADCAST#{body["broadcastId"]}',
            ':uid': user_id,
        },
        Limit=1
    )

    if existing['Items']:
        return {
            'statusCode': 409,
            'body': json.dumps({'error': 'Already reviewed this channel'})
        }

    # ãƒ¬ãƒ“ãƒ¥ãƒ¼ä½œæˆ
    review_item = {
        'PK': f'REVIEW#{review_id}',
        'SK': 'META',
        'reviewId': review_id,
        'userId': user_id,
        'broadcastId': body['broadcastId'],
        'rating': body['rating'],
        'title': body.get('title', ''),
        'content': body['content'],
        'tags': body.get('tags', []),
        'createdAt': timestamp,
        'updatedAt': timestamp,
        'helpfulCount': 0,
        'reportCount': 0,
        'status': 'ACTIVE',
        # GSIç”¨
        'GSI3PK': f'BROADCAST#{body["broadcastId"]}',
        'GSI3SK': f'REVIEW#{timestamp}',
    }

    table.put_item(Item=review_item)

    # EventBridge ã«ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
    eventbridge.put_events(
        Entries=[{
            'Source': 'auracast.reviews',
            'DetailType': 'ReviewPosted',
            'Detail': json.dumps({
                'reviewId': review_id,
                'userId': user_id,
                'broadcastId': body['broadcastId'],
                'rating': body['rating'],
                'content': body['content'],
                'timestamp': timestamp,
            }),
            'EventBusName': 'auracast-events',
        }]
    )

    return {
        'statusCode': 201,
        'body': json.dumps({'reviewId': review_id})
    }
```

#### 9.3.3 æ„Ÿæƒ…åˆ†æ Lambdaï¼ˆEventBridge ãƒˆãƒªã‚¬ãƒ¼ï¼‰

```python
# lambda/reviews/analyze_sentiment.py
import boto3
import json

comprehend = boto3.client('comprehend')
dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('auracast-main')

def handler(event, context):
    """Amazon Comprehend ã«ã‚ˆã‚‹æ„Ÿæƒ…åˆ†æ"""

    detail = event['detail']
    review_id = detail['reviewId']
    content = detail['content']

    # æ„Ÿæƒ…åˆ†æ
    sentiment_response = comprehend.detect_sentiment(
        Text=content,
        LanguageCode='ja'
    )

    # ã‚­ãƒ¼ãƒ•ãƒ¬ãƒ¼ã‚ºæŠ½å‡º
    phrases_response = comprehend.detect_key_phrases(
        Text=content,
        LanguageCode='ja'
    )

    # ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£æŠ½å‡ºï¼ˆå ´æ‰€ã€çµ„ç¹”ãªã©ã®è‡ªå‹•æ¤œå‡ºï¼‰
    entities_response = comprehend.detect_entities(
        Text=content,
        LanguageCode='ja'
    )

    # æ„Ÿæƒ…ã‚¹ã‚³ã‚¢è¨ˆç®—
    sentiment_scores = sentiment_response['SentimentScore']
    score = sentiment_scores['Positive'] - sentiment_scores['Negative']
    magnitude = max(
        sentiment_scores['Positive'],
        sentiment_scores['Negative'],
        sentiment_scores['Mixed']
    )

    # DynamoDB æ›´æ–°
    table.update_item(
        Key={'PK': f'REVIEW#{review_id}', 'SK': 'META'},
        UpdateExpression='''
            SET sentiment = :sentiment,
                keyPhrases = :phrases,
                entities = :entities
        ''',
        ExpressionAttributeValues={
            ':sentiment': {
                'score': str(score),
                'magnitude': str(magnitude),
                'label': sentiment_response['Sentiment'],
            },
            ':phrases': [p['Text'] for p in phrases_response['KeyPhrases'][:10]],
            ':entities': [
                {'text': e['Text'], 'type': e['Type']}
                for e in entities_response['Entities'][:10]
            ],
        }
    )

    # æ„Ÿæƒ…åˆ†æçµæœã‚’åˆ¥ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ä¿å­˜
    table.put_item(
        Item={
            'PK': f'REVIEW#{review_id}',
            'SK': 'SENTIMENT',
            'sentimentLabel': sentiment_response['Sentiment'],
            'sentimentScore': json.loads(json.dumps(sentiment_scores), parse_float=str),
            'keyPhrases': [p['Text'] for p in phrases_response['KeyPhrases']],
            'analyzedAt': detail['timestamp'],
        }
    )

    return {'statusCode': 200}
```

#### 9.3.4 OpenSearch ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ

```json
{
  "mappings": {
    "properties": {
      "reviewId": { "type": "keyword" },
      "userId": { "type": "keyword" },
      "broadcastId": { "type": "keyword" },
      "rating": { "type": "integer" },
      "title": {
        "type": "text",
        "analyzer": "kuromoji"
      },
      "content": {
        "type": "text",
        "analyzer": "kuromoji"
      },
      "tags": { "type": "keyword" },
      "sentiment": {
        "properties": {
          "score": { "type": "float" },
          "label": { "type": "keyword" }
        }
      },
      "keyPhrases": { "type": "keyword" },
      "createdAt": { "type": "date" },
      "location": { "type": "geo_point" }
    }
  },
  "settings": {
    "analysis": {
      "analyzer": {
        "kuromoji": {
          "type": "custom",
          "tokenizer": "kuromoji_tokenizer"
        }
      }
    }
  }
}
```

#### 9.3.5 ãƒ¬ãƒ“ãƒ¥ãƒ¼API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|---------------|---------|------|
| `/reviews` | POST | ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ |
| `/reviews/{reviewId}` | GET/PUT/DELETE | ãƒ¬ãƒ“ãƒ¥ãƒ¼æ“ä½œ |
| `/reviews/{reviewId}/helpful` | POST | ã€Œå‚è€ƒã«ãªã£ãŸã€|
| `/broadcasts/{id}/reviews` | GET | ãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸€è¦§ |
| `/reviews/search` | GET | ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¤œç´¢ï¼ˆå…¨æ–‡æ¤œç´¢ï¼‰|
| `/broadcasts/{id}/rating-summary` | GET | è©•ä¾¡ã‚µãƒãƒªãƒ¼å–å¾— |

---

### 9.4 å†ç”Ÿäººæ•°ï¼ˆãƒªã‚¹ãƒŠãƒ¼æ•°ï¼‰ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼æ•°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  ãƒªã‚¹ãƒŠãƒ¼å‚åŠ /é›¢è„±                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Flutter   â”‚â”€â”€â”€â–ºâ”‚  WebSocket  â”‚â”€â”€â”€â–ºâ”‚   Lambda    â”‚â”€â”€â”€â–ºâ”‚ ElastiCache â”‚             â”‚
â”‚  â”‚ æ¥ç¶š/åˆ‡æ–­   â”‚    â”‚  API GW     â”‚    â”‚ Connection  â”‚    â”‚   (Redis)   â”‚             â”‚
â”‚  â”‚  é€šçŸ¥       â”‚    â”‚             â”‚    â”‚  Handler    â”‚    â”‚  ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â–²                                     â”‚                  â”‚                     â”‚
â”‚         â”‚                                     â–¼                  â–¼                     â”‚
â”‚         â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚                             â”‚ EventBridge â”‚    â”‚   Lambda    â”‚             â”‚
â”‚         â”‚                             â”‚ Listener    â”‚    â”‚ å®šæœŸé›†è¨ˆ    â”‚             â”‚
â”‚         â”‚                             â”‚  Changed    â”‚    â”‚ (1åˆ†æ¯)     â”‚             â”‚
â”‚         â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â”‚                                     â”‚                  â”‚                     â”‚
â”‚         â”‚                                     â–¼                  â–¼                     â”‚
â”‚         â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  AppSync    â”‚    â”‚  DynamoDB   â”‚             â”‚
â”‚              ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡          â”‚ Subscriptionâ”‚    â”‚ çµ±è¨ˆä¿å­˜    â”‚             â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           Redis ãƒ‡ãƒ¼ã‚¿æ§‹é€                                        â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â”‚  Key: listeners:{broadcastId}        â”‚  SET  â”‚  æ¥ç¶šä¸­ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚»ãƒƒãƒˆ          â”‚   â”‚
â”‚  â”‚  Key: listener_count:{broadcastId}   â”‚  INT  â”‚  ãƒªã‚¹ãƒŠãƒ¼ç·æ•°ï¼ˆåŸå­çš„ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ï¼‰â”‚   â”‚
â”‚  â”‚  Key: hourly_peak:{broadcastId}:{h}  â”‚  INT  â”‚  æ™‚é–“åˆ¥ãƒ”ãƒ¼ã‚¯äººæ•°                â”‚   â”‚
â”‚  â”‚  Key: session:{connectionId}         â”‚ HASH  â”‚  æ¥ç¶šã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±              â”‚   â”‚
â”‚  â”‚                                                                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.4.1 WebSocket æ¥ç¶šãƒãƒ³ãƒ‰ãƒ©ãƒ¼

```python
# lambda/listeners/websocket_handler.py
import boto3
import json
import os
from datetime import datetime

redis_client = None  # Lambda LayerçµŒç”±ã§åˆæœŸåŒ–
dynamodb = boto3.resource('dynamodb')
connections_table = dynamodb.Table('auracast-websocket-connections')
eventbridge = boto3.client('events')

def get_redis():
    global redis_client
    if redis_client is None:
        import redis
        redis_client = redis.Redis(
            host=os.environ['REDIS_HOST'],
            port=6379,
            decode_responses=True
        )
    return redis_client

def connect_handler(event, context):
    """WebSocket $connect"""
    connection_id = event['requestContext']['connectionId']

    # æ¥ç¶šæƒ…å ±ä¿å­˜
    connections_table.put_item(
        Item={
            'connectionId': connection_id,
            'connectedAt': datetime.utcnow().isoformat(),
            'userId': event['requestContext'].get('authorizer', {}).get('userId'),
        }
    )

    return {'statusCode': 200}

def disconnect_handler(event, context):
    """WebSocket $disconnect"""
    connection_id = event['requestContext']['connectionId']
    r = get_redis()

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—
    session = r.hgetall(f'session:{connection_id}')

    if session and 'broadcastId' in session:
        broadcast_id = session['broadcastId']
        user_id = session.get('userId')

        # ãƒªã‚¹ãƒŠãƒ¼ã‚»ãƒƒãƒˆã‹ã‚‰å‰Šé™¤
        r.srem(f'listeners:{broadcast_id}', user_id or connection_id)

        # ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ¸›å°‘
        new_count = r.decr(f'listener_count:{broadcast_id}')

        # ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
        eventbridge.put_events(
            Entries=[{
                'Source': 'auracast.listeners',
                'DetailType': 'ListenerLeft',
                'Detail': json.dumps({
                    'broadcastId': broadcast_id,
                    'currentCount': max(0, new_count),
                    'timestamp': datetime.utcnow().isoformat(),
                }),
                'EventBusName': 'auracast-events',
            }]
        )

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤
    r.delete(f'session:{connection_id}')
    connections_table.delete_item(Key={'connectionId': connection_id})

    return {'statusCode': 200}

def join_broadcast_handler(event, context):
    """ãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å‡¦ç†"""
    connection_id = event['requestContext']['connectionId']
    body = json.loads(event['body'])
    broadcast_id = body['broadcastId']
    user_id = body.get('userId')

    r = get_redis()

    # ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜
    r.hset(f'session:{connection_id}', mapping={
        'broadcastId': broadcast_id,
        'userId': user_id or connection_id,
        'joinedAt': datetime.utcnow().isoformat(),
    })
    r.expire(f'session:{connection_id}', 3600 * 24)  # 24æ™‚é–“TTL

    # ãƒªã‚¹ãƒŠãƒ¼ã‚»ãƒƒãƒˆã«è¿½åŠ 
    r.sadd(f'listeners:{broadcast_id}', user_id or connection_id)

    # ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼å¢—åŠ 
    new_count = r.incr(f'listener_count:{broadcast_id}')

    # ãƒ”ãƒ¼ã‚¯æ›´æ–°
    hour_key = datetime.utcnow().strftime('%Y%m%d%H')
    r.set(
        f'hourly_peak:{broadcast_id}:{hour_key}',
        max(int(r.get(f'hourly_peak:{broadcast_id}:{hour_key}') or 0), new_count)
    )

    # ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
    eventbridge.put_events(
        Entries=[{
            'Source': 'auracast.listeners',
            'DetailType': 'ListenerJoined',
            'Detail': json.dumps({
                'broadcastId': broadcast_id,
                'currentCount': new_count,
                'timestamp': datetime.utcnow().isoformat(),
            }),
            'EventBusName': 'auracast-events',
        }]
    )

    return {
        'statusCode': 200,
        'body': json.dumps({'currentListeners': new_count})
    }
```

#### 9.4.2 ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡ï¼ˆAppSync Subscriptionï¼‰

```graphql
# graphql/schema.graphql

type Subscription {
  onListenerCountChanged(broadcastId: ID!): ListenerUpdate
    @aws_subscribe(mutations: ["updateListenerCount"])
}

type ListenerUpdate {
  broadcastId: ID!
  currentCount: Int!
  change: Int!
  timestamp: AWSDateTime!
}

type Mutation {
  updateListenerCount(input: ListenerCountInput!): ListenerUpdate
}

input ListenerCountInput {
  broadcastId: ID!
  currentCount: Int!
  change: Int!
}

type Query {
  getListenerCount(broadcastId: ID!): ListenerStats
  getListenerHistory(broadcastId: ID!, period: StatsPeriod!): [ListenerDataPoint!]!
}

type ListenerStats {
  broadcastId: ID!
  currentCount: Int!
  peakToday: Int!
  peakAllTime: Int!
  averageDaily: Float!
}

enum StatsPeriod {
  HOUR
  DAY
  WEEK
  MONTH
}

type ListenerDataPoint {
  timestamp: AWSDateTime!
  count: Int!
}
```

#### 9.4.3 å®šæœŸé›†è¨ˆ Lambdaï¼ˆCloudWatch Events 1åˆ†æ¯ï¼‰

```python
# lambda/listeners/aggregate_stats.py
import boto3
import json
from datetime import datetime, timedelta

dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('auracast-main')

def handler(event, context):
    """1åˆ†æ¯ã«Redisã‹ã‚‰DynamoDBã«çµ±è¨ˆã‚’æ°¸ç¶šåŒ–"""

    r = get_redis()

    # ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒãƒ£ãƒ³ãƒãƒ«ã®ãƒªã‚¹ãƒŠãƒ¼æ•°ã‚’å–å¾—
    broadcast_keys = r.keys('listener_count:*')

    timestamp = datetime.utcnow()
    minute_key = timestamp.strftime('%Y%m%d%H%M')

    for key in broadcast_keys:
        broadcast_id = key.split(':')[1]
        count = int(r.get(key) or 0)

        if count > 0:
            # åˆ†å˜ä½ã®çµ±è¨ˆä¿å­˜
            table.put_item(
                Item={
                    'PK': f'STATS#{broadcast_id}',
                    'SK': f'MINUTE#{minute_key}',
                    'count': count,
                    'timestamp': timestamp.isoformat(),
                    'TTL': int((timestamp + timedelta(days=7)).timestamp()),  # 7æ—¥å¾Œã«å‰Šé™¤
                }
            )

            # ãƒãƒ£ãƒ³ãƒãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ç¾åœ¨ãƒªã‚¹ãƒŠãƒ¼æ•°ã‚’æ›´æ–°
            table.update_item(
                Key={'PK': f'BROADCAST#{broadcast_id}', 'SK': 'META'},
                UpdateExpression='SET currentListeners = :count, lastUpdated = :ts',
                ExpressionAttributeValues={
                    ':count': count,
                    ':ts': timestamp.isoformat(),
                }
            )

    return {'statusCode': 200}
```

#### 9.4.4 ãƒªã‚¹ãƒŠãƒ¼çµ±è¨ˆAPI

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|---------------|---------|------|
| `/broadcasts/{id}/listeners` | GET | ç¾åœ¨ã®ãƒªã‚¹ãƒŠãƒ¼æ•° |
| `/broadcasts/{id}/listeners/history` | GET | ãƒªã‚¹ãƒŠãƒ¼æ•°å±¥æ­´ |
| `/broadcasts/{id}/listeners/peak` | GET | ãƒ”ãƒ¼ã‚¯çµ±è¨ˆ |
| `/stats/top-listeners` | GET | ãƒªã‚¹ãƒŠãƒ¼æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚° |
| WebSocket `/ws` | CONNECT | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¥ç¶š |
| WebSocket `joinBroadcast` | MESSAGE | ãƒãƒ£ãƒ³ãƒãƒ«å‚åŠ  |
| WebSocket `leaveBroadcast` | MESSAGE | ãƒãƒ£ãƒ³ãƒãƒ«é›¢è„± |

---

### 9.5 åœ°å›³ä¸Šã®åˆ†å¸ƒï¼ˆä½ç½®æƒ…å ±ï¼‰ã‚·ã‚¹ãƒ†ãƒ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ä½ç½®æƒ…å ±ãƒ»åœ°å›³åˆ†å¸ƒã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                         â”‚
â”‚  ä½ç½®æƒ…å ±ç™»éŒ²                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚   Flutter   â”‚â”€â”€â”€â–ºâ”‚ API Gateway â”‚â”€â”€â”€â–ºâ”‚   Lambda    â”‚â”€â”€â”€â–ºâ”‚  DynamoDB   â”‚             â”‚
â”‚  â”‚ ãƒãƒ£ãƒ³ãƒãƒ«  â”‚    â”‚ POST /venuesâ”‚    â”‚ ä½ç½®ç™»éŒ²    â”‚    â”‚ GeoHash     â”‚             â”‚
â”‚  â”‚ ä½ç½®ç™»éŒ²    â”‚    â”‚             â”‚    â”‚             â”‚    â”‚  ä¿å­˜       â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                               â”‚                  â”‚                     â”‚
â”‚                                               â–¼                  â”‚                     â”‚
â”‚                                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚                     â”‚
â”‚                                        â”‚  Location   â”‚           â”‚                     â”‚
â”‚                                        â”‚  Service    â”‚           â”‚                     â”‚
â”‚                                        â”‚ Place Index â”‚           â”‚                     â”‚
â”‚                                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚                     â”‚
â”‚                                                                  â”‚                     â”‚
â”‚  è¿‘éš£æ¤œç´¢                                                         â”‚                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚                     â”‚
â”‚  â”‚   Flutter   â”‚â”€â”€â”€â–ºâ”‚ API Gateway â”‚â”€â”€â”€â–ºâ”‚   Lambda    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚  â”‚ ç¾åœ¨åœ°ã‹ã‚‰  â”‚    â”‚GET /nearby  â”‚    â”‚ GeoHash    â”‚                                 â”‚
â”‚  â”‚ æ¤œç´¢        â”‚    â”‚             â”‚    â”‚ æ¤œç´¢       â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚         â”‚                                     â”‚                                        â”‚
â”‚         â”‚                                     â–¼                                        â”‚
â”‚         â”‚                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚         â”‚                             â”‚  Location   â”‚                                 â”‚
â”‚         â”‚                             â”‚  Service    â”‚                                 â”‚
â”‚         â”‚                             â”‚ Route Calc  â”‚                                 â”‚
â”‚         â”‚                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚         â”‚                                     â”‚                                        â”‚
â”‚         â–¼                                     â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                           Flutter Map Widget                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚     ğŸ“ Museum Audio Guide (200m)                                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚          â­ 4.5 | ğŸ‘¥ 23äºº                                                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚              ğŸ“ Cafe Jazz (500m)                                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                   â­ 4.2 | ğŸ‘¥ 45äºº                                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                              ğŸ”µ ç¾åœ¨åœ°                                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                        ğŸ“ Station Info (800m)                             â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                             â­ 3.8 | ğŸ‘¥ 12äºº                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                                           â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 9.5.1 Geohash ã‚’ä½¿ã£ãŸä½ç½®æ¤œç´¢è¨­è¨ˆ

```python
# lambda/geo/geohash_utils.py
import geohash2 as geohash

GEOHASH_PRECISION = 6  # ç´„1.2km x 0.6km ã®ç²¾åº¦

def encode_location(lat: float, lon: float, precision: int = GEOHASH_PRECISION) -> str:
    """ç·¯åº¦çµŒåº¦ã‚’Geohashã«å¤‰æ›"""
    return geohash.encode(lat, lon, precision)

def get_neighbors(gh: str) -> list:
    """éš£æ¥ã™ã‚‹8ã¤ã®Geohashã‚’å–å¾—ï¼ˆè¿‘éš£æ¤œç´¢ç”¨ï¼‰"""
    return geohash.neighbors(gh)

def decode_location(gh: str) -> tuple:
    """Geohashã‚’ç·¯åº¦çµŒåº¦ã«å¤‰æ›"""
    return geohash.decode(gh)

def get_search_hashes(lat: float, lon: float, radius_km: float) -> list:
    """
    æ¤œç´¢ç¯„å›²ã®Geohashãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
    radius_km: æ¤œç´¢åŠå¾„ï¼ˆkmï¼‰
    """
    # ç²¾åº¦ã‚’åŠå¾„ã«åŸºã¥ã„ã¦èª¿æ•´
    if radius_km <= 0.5:
        precision = 7
    elif radius_km <= 2:
        precision = 6
    elif radius_km <= 10:
        precision = 5
    else:
        precision = 4

    center_hash = geohash.encode(lat, lon, precision)
    neighbors = geohash.neighbors(center_hash)

    return [center_hash] + neighbors
```

#### 9.5.2 ä½ç½®æƒ…å ±ç™»éŒ² Lambda

```python
# lambda/geo/register_location.py
import boto3
import json
from datetime import datetime
from geo.geohash_utils import encode_location

dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('auracast-main')
location_client = boto3.client('location')

PLACE_INDEX_NAME = 'auracast-places'

def handler(event, context):
    """ãƒãƒ£ãƒ³ãƒãƒ«ã®ä½ç½®æƒ…å ±ã‚’ç™»éŒ²"""

    body = json.loads(event['body'])
    broadcast_id = body['broadcastId']
    lat = body['latitude']
    lon = body['longitude']

    # Geohash ç”Ÿæˆ
    gh = encode_location(lat, lon)
    gh_prefix = gh[:4]  # GSIç”¨ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹

    # Amazon Location Service ã§ä½æ‰€é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
    place_response = location_client.search_place_index_for_position(
        IndexName=PLACE_INDEX_NAME,
        Position=[lon, lat],
        MaxResults=1,
        Language='ja'
    )

    address = ''
    place_name = ''
    if place_response['Results']:
        place = place_response['Results'][0]['Place']
        address = place.get('Label', '')
        place_name = place.get('AddressNumber', '') or ''

    # DynamoDB ã«ä½ç½®æƒ…å ±ä¿å­˜
    timestamp = datetime.utcnow().isoformat()

    # ãƒãƒ£ãƒ³ãƒãƒ«ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°
    table.update_item(
        Key={'PK': f'BROADCAST#{broadcast_id}', 'SK': 'META'},
        UpdateExpression='''
            SET #loc = :loc, geohash = :gh, address = :addr, updatedAt = :ts
        ''',
        ExpressionAttributeNames={'#loc': 'location'},
        ExpressionAttributeValues={
            ':loc': {'latitude': str(lat), 'longitude': str(lon)},
            ':gh': gh,
            ':addr': address,
            ':ts': timestamp,
        }
    )

    # Geohash ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”¨ãƒ¬ã‚³ãƒ¼ãƒ‰
    table.put_item(
        Item={
            'PK': f'GEO#{gh_prefix}',
            'SK': f'BROADCAST#{broadcast_id}',
            'broadcastId': broadcast_id,
            'geohash': gh,
            'latitude': str(lat),
            'longitude': str(lon),
            'address': address,
            'GSI4PK': f'GEOHASH#{gh_prefix}',
            'GSI4SK': broadcast_id,
        }
    )

    return {
        'statusCode': 200,
        'body': json.dumps({
            'geohash': gh,
            'address': address,
        })
    }
```

#### 9.5.3 è¿‘éš£ãƒãƒ£ãƒ³ãƒãƒ«æ¤œç´¢ Lambda

```python
# lambda/geo/search_nearby.py
import boto3
import json
from math import radians, sin, cos, sqrt, atan2
from geo.geohash_utils import get_search_hashes, decode_location

dynamodb = boto3.resource('dynamodb')
table = dynamodb.Table('auracast-main')

def haversine_distance(lat1, lon1, lat2, lon2):
    """2ç‚¹é–“ã®è·é›¢ã‚’è¨ˆç®—ï¼ˆkmï¼‰"""
    R = 6371  # åœ°çƒã®åŠå¾„ï¼ˆkmï¼‰

    lat1, lon1, lat2, lon2 = map(radians, [lat1, lon1, lat2, lon2])
    dlat = lat2 - lat1
    dlon = lon2 - lon1

    a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
    c = 2 * atan2(sqrt(a), sqrt(1-a))

    return R * c

def handler(event, context):
    """ç¾åœ¨åœ°ã‹ã‚‰è¿‘ã„ãƒãƒ£ãƒ³ãƒãƒ«ã‚’æ¤œç´¢"""

    params = event.get('queryStringParameters', {}) or {}
    lat = float(params['latitude'])
    lon = float(params['longitude'])
    radius_km = float(params.get('radius', 5))  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5km
    limit = int(params.get('limit', 20))

    # æ¤œç´¢å¯¾è±¡ã®Geohashã‚’å–å¾—
    search_hashes = get_search_hashes(lat, lon, radius_km)

    # å„Geohashãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã§æ¤œç´¢
    candidates = []
    for gh in search_hashes:
        gh_prefix = gh[:4]

        response = table.query(
            IndexName='GSI4',
            KeyConditionExpression='GSI4PK = :pk',
            ExpressionAttributeValues={
                ':pk': f'GEOHASH#{gh_prefix}',
            }
        )
        candidates.extend(response.get('Items', []))

    # è·é›¢è¨ˆç®—ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    results = []
    seen_ids = set()

    for item in candidates:
        broadcast_id = item['broadcastId']
        if broadcast_id in seen_ids:
            continue
        seen_ids.add(broadcast_id)

        item_lat = float(item['latitude'])
        item_lon = float(item['longitude'])
        distance = haversine_distance(lat, lon, item_lat, item_lon)

        if distance <= radius_km:
            # ãƒãƒ£ãƒ³ãƒãƒ«è©³ç´°ã‚’å–å¾—
            channel_response = table.get_item(
                Key={'PK': f'BROADCAST#{broadcast_id}', 'SK': 'META'}
            )

            if 'Item' in channel_response:
                channel = channel_response['Item']
                results.append({
                    'broadcastId': broadcast_id,
                    'name': channel.get('name'),
                    'category': channel.get('category'),
                    'distance': round(distance, 2),
                    'distanceUnit': 'km',
                    'location': {
                        'latitude': item_lat,
                        'longitude': item_lon,
                    },
                    'address': item.get('address'),
                    'currentListeners': channel.get('currentListeners', 0),
                    'avgRating': channel.get('avgRating', 0),
                })

    # è·é›¢ã§ã‚½ãƒ¼ãƒˆ
    results.sort(key=lambda x: x['distance'])

    return {
        'statusCode': 200,
        'body': json.dumps({
            'broadcasts': results[:limit],
            'searchCenter': {'latitude': lat, 'longitude': lon},
            'searchRadius': radius_km,
            'totalFound': len(results),
        })
    }
```

#### 9.5.4 Amazon Location Service è¨­å®š

```typescript
// infrastructure/lib/constructs/location-construct.ts
import * as location from 'aws-cdk-lib/aws-location';

// Place Indexï¼ˆé€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”¨ï¼‰
const placeIndex = new location.CfnPlaceIndex(this, 'AuracastPlaceIndex', {
  indexName: 'auracast-places',
  dataSource: 'Esri',  // ã¾ãŸã¯ 'Here'
  dataSourceConfiguration: {
    intendedUse: 'SingleUse',
  },
  pricingPlan: 'RequestBasedUsage',
});

// Mapï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´åœ°å›³è¡¨ç¤ºç”¨ï¼‰
const map = new location.CfnMap(this, 'AuracastMap', {
  mapName: 'auracast-map',
  configuration: {
    style: 'VectorEsriNavigation',
  },
  pricingPlan: 'RequestBasedUsage',
});

// Geofence Collectionï¼ˆä»»æ„ï¼šã‚¨ãƒªã‚¢é€šçŸ¥ç”¨ï¼‰
const geofenceCollection = new location.CfnGeofenceCollection(this, 'AuracastGeofences', {
  collectionName: 'auracast-geofences',
  pricingPlan: 'RequestBasedUsage',
});
```

#### 9.5.5 ä½ç½®æƒ…å ± API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

| ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ | ãƒ¡ã‚½ãƒƒãƒ‰ | èª¬æ˜ |
|---------------|---------|------|
| `/broadcasts/nearby` | GET | è¿‘éš£ãƒãƒ£ãƒ³ãƒãƒ«æ¤œç´¢ |
| `/broadcasts/{id}/location` | GET/PUT | ä½ç½®æƒ…å ±å–å¾—ãƒ»æ›´æ–° |
| `/venues` | GET/POST | ä¼šå ´ä¸€è¦§ãƒ»ç™»éŒ² |
| `/venues/{id}/broadcasts` | GET | ä¼šå ´ã®ãƒãƒ£ãƒ³ãƒãƒ«ä¸€è¦§ |
| `/map/tiles/{z}/{x}/{y}` | GET | åœ°å›³ã‚¿ã‚¤ãƒ«ï¼ˆLocation ServiceçµŒç”±ï¼‰|
| `/geocode/reverse` | GET | é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° |

---

## 10. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### Phase 1: åŸºç›¤æ§‹ç¯‰
- [ ] Flutter ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–
- [ ] Android Method Channel ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- [ ] AWS CDK ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£æ§‹ç¯‰
- [ ] DynamoDB ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼ˆSingle-Table + 5 GSIï¼‰
- [ ] EventBridge ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¹è¨­å®š

### Phase 2: ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼ã‚·ã‚¹ãƒ†ãƒ 
- [ ] Cognito User Pool è¨­å®š
- [ ] ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ãƒ­ã‚°ã‚¤ãƒ³ï¼ˆGoogle/Appleï¼‰è¨­å®š
- [ ] Post Confirmation Lambda å®Ÿè£…
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ« API å®Ÿè£…
- [ ] Flutter Amplify Auth çµ±åˆ

### Phase 3: Bluetoothå®Ÿè£…
- [ ] AuracastScannerå®Ÿè£…ï¼ˆBluetoothLeScanner + ScanFilterï¼‰
- [ ] BassGattManagerå®Ÿè£…ï¼ˆBASS GATTæ“ä½œï¼‰
- [ ] Add Source / Remove Sourceæ“ä½œ
- [ ] Broadcast Receive Stateç›£è¦–
- [ ] Flutter Providerçµ±åˆ

### Phase 4: ã‚³ã‚¢æ©Ÿèƒ½
- [ ] ãƒ–ãƒ­ãƒ¼ãƒ‰ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§UI
- [ ] æ¥ç¶šãƒ»åˆ‡æ–­ãƒ•ãƒ­ãƒ¼
- [ ] ãŠæ°—ã«å…¥ã‚Šä¿å­˜æ©Ÿèƒ½
- [ ] ãƒªã‚¹ãƒ‹ãƒ³ã‚°å±¥æ­´

### Phase 5: ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ã‚·ã‚¹ãƒ†ãƒ 
- [ ] Kinesis Data Streams è¨­å®š
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼è¡Œå‹•ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡å®Ÿè£…
- [ ] Amazon Personalize ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆè¨­å®š
- [ ] Personalize ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ä½œæˆ
- [ ] ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ API Lambda å®Ÿè£…
- [ ] Flutter ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰UI å®Ÿè£…

### Phase 6: å£ã‚³ãƒŸè©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ 
- [ ] ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ API å®Ÿè£…
- [ ] Amazon Comprehend æ„Ÿæƒ…åˆ†æ Lambda å®Ÿè£…
- [ ] OpenSearch Service ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼è¨­å®š
- [ ] ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¤œç´¢ãƒ»ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ Lambda å®Ÿè£…
- [ ] è©•ä¾¡é›†è¨ˆ Lambda å®Ÿè£…
- [ ] Flutter ãƒ¬ãƒ“ãƒ¥ãƒ¼UI å®Ÿè£…

### Phase 7: ãƒªã‚¹ãƒŠãƒ¼æ•°ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
- [ ] ElastiCache (Redis) ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼è¨­å®š
- [ ] WebSocket API Gateway è¨­å®š
- [ ] WebSocket æ¥ç¶š/åˆ‡æ–­ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ Lambda å®Ÿè£…
- [ ] ãƒªã‚¹ãƒŠãƒ¼å‚åŠ /é›¢è„±å‡¦ç† Lambda å®Ÿè£…
- [ ] AppSync Subscription è¨­å®š
- [ ] å®šæœŸé›†è¨ˆ Lambdaï¼ˆCloudWatch Eventsï¼‰å®Ÿè£…
- [ ] Flutter ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼æ•°UI å®Ÿè£…

### Phase 8: åœ°å›³ãƒ»ä½ç½®æƒ…å ±ã‚·ã‚¹ãƒ†ãƒ 
- [ ] Amazon Location Service è¨­å®šï¼ˆPlace Index, Mapï¼‰
- [ ] Geohash ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£å®Ÿè£…
- [ ] ä½ç½®æƒ…å ±ç™»éŒ² Lambda å®Ÿè£…
- [ ] è¿‘éš£ãƒãƒ£ãƒ³ãƒãƒ«æ¤œç´¢ Lambda å®Ÿè£…
- [ ] Flutter åœ°å›³ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆçµ±åˆï¼ˆflutter_map or google_maps_flutterï¼‰
- [ ] ä½ç½®æƒ…å ±ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³å‡¦ç†

### Phase 9: é«˜åº¦ãªæ©Ÿèƒ½
- [ ] Broadcast Codeå…¥åŠ›UIï¼ˆæš—å·åŒ–æ”¾é€å¯¾å¿œï¼‰
- [ ] è¤‡æ•°BISé¸æŠUI
- [ ] ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ï¼ˆSNS + FCMï¼‰
- [ ] ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ

### Phase 10: ãƒªãƒªãƒ¼ã‚¹æº–å‚™
- [ ] CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œæˆ
- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
- [ ] è² è·ãƒ†ã‚¹ãƒˆï¼ˆãƒªã‚¹ãƒŠãƒ¼æ•°åŒæ™‚æ¥ç¶šï¼‰
- [ ] Play Store ç”³è«‹æº–å‚™

---

## 11. é‡è¦ãªè€ƒæ…®äº‹é …

### 11.1 æŠ€è¡“çš„åˆ¶ç´„

1. **Extended Advertisingå¿…é ˆ**: `ScanSettings.setLegacy(false)` ã‚’è¨­å®šã—ãªã„ã¨Auracastæ”¾é€ã‚’æ¤œå‡ºã§ããªã„

2. **PA Syncåˆ¶é™**: ã‚¢ãƒ—ãƒªãƒ¬ãƒ™ãƒ«ã§ã¯PAï¼ˆPeriodic Advertisingï¼‰Syncã‚’ç›´æ¥åˆ¶å¾¡ã§ããªã„ã€‚ã‚¤ãƒ¤ãƒ›ãƒ³å´ã®BASSãŒPA Syncã‚’ç®¡ç†ã™ã‚‹

3. **BIG Syncåˆ¶é™**: åŒæ§˜ã«BIG Syncã‚‚ã‚¤ãƒ¤ãƒ›ãƒ³å´ã§ç®¡ç†ã€‚ã‚¢ãƒ—ãƒªã¯BASSçµŒç”±ã§æŒ‡ç¤ºã‚’å‡ºã™ã®ã¿

### 11.2 äº’æ›æ€§ãƒãƒˆãƒªã‚¯ã‚¹

| TWSå´è¦ä»¶ | èª¬æ˜ |
|-----------|------|
| BASS GATT Service | ã‚¤ãƒ¤ãƒ›ãƒ³ãŒBASSã‚’å…¬é–‹ã—ã¦ã„ã‚‹ã“ã¨ |
| LE Audio Sink | Broadcast Sinkæ©Ÿèƒ½å¯¾å¿œ |
| PA Syncå¯¾å¿œ | Periodic Advertisingå—ä¿¡å¯èƒ½ |

### 11.3 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

- Broadcast Codeã¯`flutter_secure_storage`ã§æš—å·åŒ–ä¿å­˜
- AWS Secrets Managerã§æœ¬ç•ªAPIã‚­ãƒ¼ç®¡ç†
- GATTé€šä¿¡ã¯BLEæš—å·åŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ä¿è­·

### 11.4 ãƒ‡ãƒãƒƒã‚°Tips

```bash
# Android BLE HCI snoop logæœ‰åŠ¹åŒ–
adb shell settings put secure bluetooth_hci_log 1
# å†èµ·å‹•å¾Œã€/data/misc/bluetooth/logs/ ã§ãƒ­ã‚°å–å¾—

# GATTæ“ä½œç¢ºèª
adb logcat -s "BluetoothGatt"
```

---

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Airoha SDKã«ä¾å­˜ã›ãšã€Androidæ¨™æº–BLE APIã¨ã‚¤ãƒ¤ãƒ›ãƒ³å´BASS GATTã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ãŸã‚¢ãƒ—ãƒªå†…å®Œçµã®Auracast Assistantå®Ÿè£…ã‚’å®šç¾©ã—ã¦ã„ã¾ã™ã€‚
